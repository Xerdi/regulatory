\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{regulatory}[2022/06/19 Xerdi's Regulatory Package]

\RequirePackage{xifthen}
\RequirePackage{keyval}
\RequirePackage{xstring}
\RequirePackage{xspace}

\newboolean{regulatory@usemarkdown}
\setboolean{regulatory@usemarkdown}{false}
\DeclareOption{markdown}{%
    \setboolean{regulatory@usemarkdown}{true}%
}

\newboolean{regulatory@usebib2gls}
\setboolean{regulatory@usebib2gls}{false}
\DeclareOption{bibdefs}{\setboolean{regulatory@usebib2gls}{true}}

\DeclareOption{hidelinks}{%
    \PassOptionsToPackage{hidelinks}{hyperref}}

\newboolean{regulatory@alldefs}
\setboolean{regulatory@alldefs}{false}
\DeclareOption{alldefs}{\setboolean{regulatory@alldefs}{true}}

% Verwijzingen koppelen met (standaard) , en afbreken met juncto (zie \setconjunction)
\newcommand{\crefpairconjunction}{ en~}
\newcommand{\creflastconjunction}{ en~}
\newcommand{\crefrangeconjunction}{tot~}

\newcommand\setjuncto{%
\renewcommand{\crefpairconjunction}{ jo.\ }%
\renewcommand{\creflastconjunction}{ jo.\ }%
}

\newcommand\unsetjuncto{%
\renewcommand{\crefpairconjunction}{ en~}%
\renewcommand{\creflastconjunction}{ en~}%
}

\DeclareOption{juncto}{%
    \setjuncto}

\DeclareOption*{\PackageError{regulatory}{Unknown option}{Options are markdown}}
%\ProcessOptionsX
\ProcessOptions*

\edef\@regulatory@bib@selection{}
\ifthenelse{\boolean{regulatory@alldefs}}{\edef\@regulatory@bib@selection{,selection=all}}{}

% Markdown support
\ifthenelse{\boolean{regulatory@usemarkdown}}{
\RequirePackage[hashEnumerators,definitionLists,hybrid,headerAttributes=true]{markdown}
\def\@uitlijning{Lorem ipsum dolor sit amet.}%
\newcommand{\uitlijning}[1]{\def\@uitlijning{#1}}%
\setkeys{markdownRenderers}{
headingOne={\artikel{#1}},
olItemWithNumber={\item{}},
olBeginTight={\begin{leden}},
olEndTight={\end{leden}},
olBegin={\begin{leden}},
olEnd={\end{leden}},
dlBeginTight={\begin{labeling}{\@uitlijning}},
dlEndTight={\end{labeling}},
dlBegin={\begin{labeling}{\@uitlijning}},
dlEnd={\end{labeling}}%
\renewcommand\markdownRendererOlItemWithNumber[1]{\item{}\label{ml:##1}}
}
}{}

% Pakketten nÃ¡ markdown (anders gaat enumitem kapot)
\RequirePackage{xcolor}
\RequirePackage{xassoccnt}
\RequirePackage{xpatch}
\RequirePackage{titlesec} % voor artikelen
\RequirePackage{enumitem} % voor leden/subleden
\RequirePackage{fmtcount} % voor tekstuele leden
\RequirePackage{scrextend} % voor definitie lijsten
%\RequirePackage{xr-hyper} % TODO: kan weg?
\RequirePackage{hyperref} % voor linkjes
\RequirePackage[user,counter,hyperref,xr]{zref} % voor verwijzingen
\RequirePackage{zref-xr,zref-user,zref-clever,zref-hyperref}
%\RequirePackage{cleveref} % voor verwijzingen
\RequirePackage{pgf} % voor entities
\RequirePackage{suffix} % voor macro's met asterisk
\RequirePackage[sanitize=none,nonumberlist]{glossaries} % voor definitie lijsten

\newboolean{regulatory@defslisted}
\setboolean{regulatory@defslisted}{false}
% Glossary overrides
\setglossarystyle{alttree}
\renewcommand{\glossarysection}[2][]{}
\renewcommand*{\glsnamefont}[1]{\textmd{\textit{#1}}}
\renewcommand*{\glstextformat}{\textit}

% Kleuren
\colorlet{artlabel}{black}
\colorlet{arttitle}{black}
\colorlet{lidlabel}{black}
\colorlet{lidtitle}{black}
\colorlet{sublabel}{black}
\colorlet{subtitle}{black}


% Artikelen
\newcounter{artikel}
\titleclass{\artikel}{straight}[\part]
\titleformat{\artikel}{\normalfont\color{arttitle}}{\bfseries\color{artlabel}Artikel \theartikel.\quad}{1em}{}
\titlespacing*{\artikel}{0pt}{3.5ex plus 1ex minus .2ex}{5pt}

\newcounter{lid}
\titleclass{\lid}{straight}[\part]
\titleformat{\lid}{\normalfont\color{lidtitle}}{\normalfont\color{lidlabel}\theartikel.\thelid.\quad}{1em}{}
\titlespacing*{\lid}{0pt}{3.5ex plus 1ex minus .2ex}{5pt}
\counterwithin{lid}{artikel}

\renewcommand{\theartikel}{\arabic{artikel}}
\renewcommand{\thelid}{\arabic{lid}}
\makeatletter
\newcommand{\l@artikel}{\@dottedtocline{1}{1.5em}{2.3em}}
\def\toclevel@artikel{2}
\newcommand{\l@lid}{\@dottedtocline{1}{3.8em}{2.3em}}
\def\toclevel@lid{3}

% Leden en subleden
\newlist{leden}{enumerate}{2}
\setlist[leden,1]{label=\theartikel.\arabic*.,ref=\arabic*,align=left,itemsep=0pt}
\setlist[leden,2]{label=\abalphnum{\arabic*}),ref=\arabic*,itemsep=0pt}
\counterwithin{ledeni}{artikel}
\counterwithin{ledenii}{ledeni}

% Verwijzingsnaam naar leden en subleden (lid/sub)
%\crefname{artikel}{artikel}{artikelen}
%\crefname{lid}{lid\unskip}{leden\unskip}
%\crefname{ledeni}{lid\unskip}{leden\unskip}
%\crefname{ledenii}{onderdeel\unskip}{onderdelen\unskip}

\zref@newprop{artikel}[-1]{\number\value{artikel}}
\zref@newprop{lid}[-1]{\ifnum\value{lid}>0\number\value{lid}\else\number\value{ledeni}\fi}
\zref@newprop{sub}[-1]{\number\value{ledenii}}
\zref@addprops{main}{artikel,lid,sub}

\makeatother
{\catcode`\#=12 \gdef\hashchar{#}}
\makeatletter
%\newcommand\@aref@hl[2]{\edef\next{%
%    \noexpand\href{%
%    \zref@extractdefault{#1}{url}{}%
%    \zref@ifrefcontainsprop{#1}{anchor}{\hashchar\zref@extract{#1}{anchor}}{}}%
%      {#2}}\next}
\newcommand\@aref@hl[1]{\edef\next{%
    \noexpand\href{\@aref@fullurl}{#1}}\next}
\newcommand\test[1]{\@aref@setvars{#1}\@aref@hl{TEST}}

% Artikel labels
\def\@aref@artikel@prefix{artikel~}
\def\@Aref@artikel@prefix{Artikel~}
\def\@aref@artikel@postfix{}
\def\@aref@artikel@format{\@aref@artikel}
\def\@aref@artikel@formathl{\@aref@hl{\@aref@artikel@format}}
\def\@aref@artikel@nformat{\@aref@artikel@prefix\@aref@artikel}
\def\@Aref@artikel@nformat{\@Aref@artikel@prefix\@aref@artikel}
\def\@aref@artikel@nformathl{\@aref@artikel@prefix\@aref@artikel@formathl}
\def\@Aref@artikel@nformathl{\@Aref@artikel@prefix\@aref@artikel@formathl}


% Lid labels
\def\@aref@lid@prefix{}
\def\@Aref@lid@prefix{}
\def\@aref@lid@postfix{~lid}
\def\@aref@lid@format{\ordinalstringnum{\@aref@lid}}
\def\@Aref@lid@format{\Ordinalstringnum{\@aref@lid}}
\def\@aref@lid@formathl{\@aref@hl{\@aref@lid@format}}
\def\@Aref@lid@formathl{\@aref@hl{\@Aref@lid@format}}
\def\@aref@lid@nformat{\@aref@lid@format\@aref@lid@postfix}
\def\@aref@lid@nformathl{\@aref@lid@formathl\@aref@lid@postfix}
\def\@Aref@lid@nformat{\@Aref@lid@format\@aref@lid@postfix}
\def\@Aref@lid@nformathl{\@Aref@lid@formathl\@aref@lid@postfix}

% Sub labels
\def\@aref@sub@prefix{onderdeel~}
\def\@Aref@sub@prefix{Onderdeel~}
\def\@aref@sub@postfix{}
\def\@aref@sub@format{\abalphnum{\@aref@sub}}
\def\@aref@sub@formathl{\@aref@hl{\@aref@sub@format}}
\def\@aref@sub@nformat{\@aref@sub@prefix\@aref@sub@format}
\def\@aref@sub@nformathl{\@aref@sub@prefix\@aref@sub@formathl}
\def\@Aref@sub@nformat{\@Aref@sub@prefix\@aref@sub@format}
\def\@Aref@sub@nformathl{\@Aref@sub@prefix\@aref@sub@formathl}



\newcommand\@aref@setvars[1]{%
    \def\@aref@count{\zref@extract{#1}{counter}}%
    \def\@aref@artikel{\zref@extract{#1}{artikel}}%
    \def\@aref@lid{\zref@extract{#1}{lid}}%
    \def\@aref@sub{\zref@extract{#1}{sub}}%
    \def\@aref@anchor{\zref@extract{#1}{anchor}}%
    \def\@aref@url{\zref@extractdefault{#1}{url}{}}%
    \def\@aref@fullurl{\@aref@url\hashchar\@aref@anchor}%
    \ifthenelse{\equal{\@aref@count}{artikel}}{%
        \def\@aref@type{artikel}%
        \def\@aref@format{\@aref@artikel@formathl}%
        \def\@aref@formatn{\@ifacap{\@Aref@artikel@prefix}{\@aref@artikel@prefix}\@aref@format}%
        \def\@aref@prefix{\@ifacap{\@Aref@artikel@prefix}{\@aref@artikel@prefix}}%
        \def\@aref@postfix{}%
    }{%
        \ifthenelse{\equal{\@aref@count}{ledeni}\OR\equal{\@aref@count}{lid}}{%
            \def\@aref@type{lid}%
            \def\@aref@format{\@ifacap{\@Aref@lid@formathl}{\@aref@lid@formathl}}%
            \def\@aref@formatn{\@aref@format\@aref@lid@postfix}%
            \def\@aref@prefix{%
                \@ifacap{\@Aref@artikel@prefix}{\@aref@artikel@prefix}\@aref@artikel@format,~%
            }%
            \def\@aref@postfix{\@aref@lid@postfix}%
        }{%
            \ifthenelse{\equal{\@aref@count}{ledenii}}{%
                \def\@aref@type{sub}%
                \def\@aref@format{\@aref@sub@formathl}%
                \def\@aref@prefix{%
                    \@ifacap{\@Aref@artikel@prefix}{\@aref@artikel@prefix}\@aref@artikel@format,~%
                    \@ifacap{\@Aref@lid@format}{\@aref@lid@format}\@aref@lid@postfix,~%
                    \@ifacap{\@Aref@sub@prefix}{\@aref@sub@prefix}%
                }%
                \def\@aref@postfix{}%
            }{%
                \def\@aref@type{page}%
                \def\@aref@format{??}%
                \def\@aref@prefix{}%
                \def\@aref@postfix{}%
            }%
        }%
    }%
    \def\@aref@number##1{\zref@extractdefault{##1}{\@aref@type}{-1}}%
}

\newboolean{aref@cap}
\def\@ifacap#1#2{\ifthenelse{\boolean{aref@cap}}{#1\setboolean{aref@cap}{false}}{#2}}

% https://tex.stackexchange.com/questions/164118/special-case-for-last-element-with-foreach
\newcommand{\aref}[1]{%
    \IfSubStr{#1}{,}{%
        \StrBefore[1]{#1}{,}[\firstarg]%
    }{%
        \def\firstarg{#1}%
    }%
    \@aref@setvars{\firstarg}%
    \@aref@prefix\aref@group{#1}\@aref@postfix%
}

\newcommand{\Aref}[1]{%
    \setboolean{aref@cap}{true}%
    \IfSubStr{#1}{,}{%
        \StrBefore[1]{#1}{,}[\Firstarg]%
    }{%
        \def\Firstarg{#1}%
    }%
    \@aref@setvars{\Firstarg}%
    \@aref@prefix\aref@group{#1}\@aref@postfix%
}


\def\listterminator{-1}% SET TO *ANY* VALUE KNOWN NOT TO BE IN LIST (POSITIVE OR NEGATIVE)
\newcommand\middleconjunction{,\ }
\newcommand\lastconjunction{ en }
\newcommand\rangeconjunction{ t/m }
\newcommand\aref@group[1]{%
    \bubblesort{#1}%
    \expandafter\begincompaction\sortedlist,\listterminator,\relax%
}
\def\begincompaction#1,#2\relax{%
    \def\startlist{#1}%
    \def\currentendlist{#1}%
    \findendlist#2\relax%
}
\def\findendlist#1,#2\relax{%
    \@aref@setvars{#1}%
    \ifnum\numexpr\@aref@number{\currentendlist}+1\relax=\@aref@number{#1}\relax%
        \def\currentendlist{#1}%
        \findendlist#2\relax%
    \else%
        \@aref@setvars{\startlist}%
        \ifnum\@aref@number{\startlist}=\@aref@number{\currentendlist}\relax%
            \ignorespaces\@aref@format\unskip%
        \else%
            \ifnum\numexpr\@aref@number{\startlist}+1\relax=\@aref@number{\currentendlist}\relax%
                \ignorespaces\@aref@format\unskip%
                \ifnum\@aref@number{#1}=\listterminator\relax%
                    \lastconjunction%
                \else%
                    \middleconjunction%
                \fi\ignorespaces\@aref@setvars{\currentendlist}\@aref@format\unskip%
            \else%
                \ignorespaces\@aref@format\unskip\rangeconjunction\ignorespaces\@aref@setvars{\currentendlist}\@aref@format\unskip%
            \fi%
        \fi%
        \ifnum\@aref@number{#1}=\listterminator%
        \else%
            \IfStrEq{#2}{\listterminator,}{\lastconjunction}{\middleconjunction}\begincompaction#1,#2\relax%
        \fi%
    \fi%
}
\newcommand\bubblesort[1]{\def\sortedlist{}\sortlist#1,\listterminator,\relax}
\def\sortlist#1,#2,#3\relax{%
    \@aref@setvars{#1}%
    \ifnum\@aref@number{#2}=\listterminator\relax%
        \edef\sortedlist{\sortedlist#1}%
    \else%
        \ifnum\@aref@number{#1}<\@aref@number{#2}\relax%
            \edef\sortedlist{\sortedlist#1,}%
            \sortlist#2,#3\relax%
        \else%
            \let\tmp\sortedlist%
            \def\sortedlist{}%
            \expandafter\sortlist\tmp#2,#1,#3\relax%
        \fi%
    \fi%
}

\GetAllResetLists
\RegisterPostLabelHook{\zlabel}

\newcommand\newentity[2]{
    \pgfkeys{
        /entity/#1/.is family,
        /entity/#1,
        name/.initial=<naam>,
        title/.initial=<functie titel>,
        gender/.initial=<male|female>,
        company/.initial=<bedrijf>,
        kvk/.initial=<kvk nummer>,
        website/.initial=<website>,
        email/.initial=<e-mail>,
        address/.initial=<adres>,
        postal/.initial=<postcode>,
        place/.initial=<plaats>,
        iban/.initial=<iban>,
        sign date/.initial=<datum>,
        sign place/.initial=<plaats>
    }
    \pgfkeys{/entity/#1,#2}
}
\newcommand\entityval[2]{\pgfkeysvalueof{/entity/#1/#2}\xspace}
\newcommand\nameOf[1]{\entityval{#1}{name}}
\newcommand\titleOf[1]{\entityval{#1}{title}}
\newcommand\companyOf[1]{\entityval{#1}{company}}
\newcommand\kvkOf[1]{\entityval{#1}{kvk}}
\newcommand\websiteOf[1]{\entityval{#1}{website}}
\newcommand\emailOf[1]{\entityval{#1}{email}}
\newcommand\addressOf[1]{\entityval{#1}{address}}
\newcommand\postalOf[1]{\entityval{#1}{postal}}
\newcommand\placeOf[1]{\entityval{#1}{place}}
\newcommand\ibanOf[1]{\entityval{#1}{iban}}
\newcommand\signdateOf[1]{\entityval{#1}{sign date}}
\newcommand\signplaceOf[1]{\entityval{#1}{sign place}}

\newcommand\salute[1]{%
    \ifthenelse{\equal{\pgfkeysvalueof{/entity/#1/gender}}{female}}{mevrouw }{de heer }%
    \nameOf{#1}%
}
\WithSuffix\newcommand\salute*[1]{%
    \ifthenelse{\equal{\pgfkeysvalueof{/entity/#1/gender}}{female}}{mevr.\ }{dhr.\ }%
    \nameOf{#1}%
}

\newcommand\Salute[1]{%
    \ifthenelse{\equal{\pgfkeysvalueof{/entity/#1/gender}}{female}}{Mevrouw }{De heer }%
    \nameOf{#1}%
}

\WithSuffix\newcommand\Salute*[1]{%
    \ifthenelse{\equal{\pgfkeysvalueof{/entity/#1/gender}}{female}}{Mevr.\ }{Dhr.\ }%
    \nameOf{#1}%
}

\newcommand\signature[1]{
    \@ifpackageloaded{tabularx}{%
    \noindent\textbf{\companyOf{#1}} \\
    \vspace{3cm}\\
    {\tiny Handtekening:}\\[-1em]
    \rule{\linewidth}{.1pt}
    \\[1em]
    \begin{tabularx}{\linewidth}{@{}p{\widthof{Functie:\quad}}@{}X@{}}
        Naam:    & \nameOf{#1}      \\
        Functie: & \titleOf{#1}     \\
        Datum:   & \signdateOf{#1}  \\
        Plaats:  & \signplaceOf{#1} \\
    \end{tabularx}
    }{\PackageError{regulatory}{Missing tabularx}{The package tabularx needs to be loaded}}
}

\newcommand\contact[1]{%
%    \artikel{Contactgegevens \companyOf{#1}, \nameOf{#1}}\label{art:contact}
    \@ifpackageloaded{tabularx}{%
    \begin{tabularx}{\linewidth}{@{}l l X l l@{}}
        Bedrijfsnaam:       & \companyOf{#1}               & & KvK-nummer: & \kvkOf{#1}     \\
        Adres:              & \addressOf{#1}               & & E-mail:     & \emailOf{#1}   \\
        Postcode en plaats: & \postalOf{#1}, \placeOf{#1} & & Website:    & \websiteOf{#1} \\
    \end{tabularx}
    }{\PackageError{regulatory}{Missing tabularx}{The package tabularx needs to be loaded}}
}

\newcommand*\contractor{contractor}
\newcommand\client{client}

\newcommand\myname{\nameOf{\contractor}}
\newcommand\mytitle{\titleOf{\contractor}}
\newcommand\mycompany{\companyOf{\contractor}}
\newcommand\mykvk{\kvkOf{\contractor}}
\newcommand\mywebsite{\websiteOf{\contractor}}
\newcommand\myemail{\pgfkeysvalueof{/entity/\contractor/email}}
\newcommand\myaddress{\pgfkeysvalueof{/entity/\contractor/address}}
\newcommand\mypostal{\pgfkeysvalueof{/entity/\contractor/postal}}
\newcommand\myplace{\pgfkeysvalueof{/entity/\contractor/place}}
\newcommand\myiban{\pgfkeysvalueof{/entity/\contractor/iban}}
\newcommand\mysigndate{\pgfkeysvalueof{/entity/\contractor/sign date}}
\newcommand\mysignplace{\pgfkeysvalueof{/entity/\contractor/sign place}}

%\newcommand\contractor{contractor}
\newcommand\setcontractor[1]{\renewcommand\contractor{#1}}
%\newcommand\client{client}
\newcommand\setclient[1]{\renewcommand\client{#1}}

\IfFileExists{entities.tex}{%
    \input{entities.tex}
}{\PackageWarning{regulatory}{No entities.tex found}}

% Schakelbepalingen
%\RequirePackage{attachfile}
\makeatletter
\newcommand*{\addFileDependency}[1]{% argument=file name and extension
\typeout{(#1)}
\@addtofilelist{#1}
\IfFileExists{#1}{}{\typeout{No file #1.}}
}
% https://www.overleaf.com/learn/how-to/Cross_referencing_with_the_xr_package_in_Overleaf
\makeatother
\newcommand{\extdoc}[2][ext-]{%
\externaldocument[#1]{../../#2/out/main}%
\addFileDependency{../../#2/src/main.tex}%
\addFileDependency{../../#2/out/main.aux}%
}

\makeatletter

\newglossary*{definitions}{Definitions}
\newglossary*{externals}{Externals}
\newignoredglossary{externals}
% Macro's
\newcommand\describe[1]{\glstarget{#1}{\glsentrydesc{#1}.}}
%\newcommand\describe[1]{\setboolean{regulatory@defslisted}{true}\glstarget{#1}{\glsentrydesc{#1}.}}
\newcommand\printdefs[1]{%
    \setboolean{regulatory@defslisted}{true}%
    \glssetwidest{#1\quad}%
    \ifthenelse{\boolean{regulatory@usebib2gls}}{\printunsrtglossary[type=definitions]}{\printglossary[type=definitions]}}

\newcommand\@regulatory@extradefs{}
\newcommand\extradefs[1]{\renewcommand\@regulatory@extradefs{,#1}}

\newcommand\loadglsdefs[1]{%
    \setboolean{regulatory@defslisted}{true}%
    \ifthenelse{\boolean{regulatory@usebib2gls}}{%
        \GlsXtrLoadResources[type=definitions,src={#1},sort={nl-NL},category={defs}\@regulatory@bib@selection]%
    }{%
        \loadglsentries[definitions]{#1}%
    }%
}

%\glssetcategoryattribute{external}{targeturl}{algemene_voorwaarden.pdf}
%\glssetcategoryattribute{external}{targetname}{\glolinkprefix\glslabel}
%\glssetcategoryattribute{external}{refered}{false}
%\newignoredglossary*{external}
%\glsdefpostlink{external}{%
%    \glsxtrifwasfirstuse{% true case
%        \ifthenelse{\equal{\glsgetcategoryattribute{defs}{refered}}{false}}{%
%        \glssetcategoryattribute{defs}{refered}{true}%
%        \glsifcategory{\glslabel}{defs}{%
%%        \glsxtrifhasfield{useri}{\glslabel}{\space%
%        % \glscurrentfieldvalue needs to be expanded
%        % before being passed to \cite.
%            ~(zie Algemene Voorwaarden\footnote{\href{\glsgetcategoryattribute{defs}{targeturl}}{Algemene Voorwaarden}})}%
%        }{}% false refered
%%        {}% false glsxtrifhasfield
%    }% end true glsxtrifwasfirstuse
%    {}%{<false>} glsxtrifwasfirstuse
%} % end glsdefpostlink

%\newignoredglossary{ignored}
%\GlsXtrLoadResources[
%src=example-glossaries-acronym,
%trigger-type=ignored,
%category=abbreviation
%]

\ifthenelse{\boolean{regulatory@usebib2gls}}{%
    \RequirePackage[record,style=alttree]{glossaries-extra}
    \setboolean{regulatory@defslisted}{true}
    \AtEndPreamble{\loadglsdefs{defs\@regulatory@extradefs}}
}{%
    \IfFileExists{defs.tex}{%
        \AtEndPreamble{
        \setboolean{regulatory@defslisted}{true}%
        \loadglsentries{defs.tex}\makeglossaries}}{%
        \PackageWarning{regulatory}{No defs.tex found}}%
}
\ifthenelse{\boolean{regulatory@defslisted}}{}{\glsdisablehyper}
\AtEndDocument{\ifthenelse{\boolean{regulatory@alldefs}}{\glsaddallunused}{}}

\makeatother
