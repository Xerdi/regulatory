\NeedsTeXFormat{LaTeX2e}

\ProvidesPackage{regulatory}[2022/06/19 Xerdi's Regulatory Package]
\RequirePackage{xifthen}
\RequirePackage{keyval}
\RequirePackage{xstring}

\newboolean{regulatory@usemarkdown}
\setboolean{regulatory@usemarkdown}{false}
\DeclareOption{markdown}{%
    \setboolean{regulatory@usemarkdown}{true}%
}

% Verwijzingen koppelen met (standaard) , en afbreken met juncto (zie \setconjunction)
\newcommand{\crefpairconjunction}{ en~}
\newcommand{\creflastconjunction}{ en~}
\newcommand{\crefrangeconjunction}{tot~}

\newcommand\setjuncto{%
\renewcommand{\crefpairconjunction}{ jo.\ }%
\renewcommand{\creflastconjunction}{ jo.\ }%
}

\newcommand\unsetjuncto{%
\renewcommand{\crefpairconjunction}{ en~}%
\renewcommand{\creflastconjunction}{ en~}%
}

\DeclareOption{juncto}{%
    \setjuncto}

% Let every unkown option throw an error
\DeclareOption*{\PackageError{regulatory}{Unknown option}{Options are markdown}}
\ProcessOptions*

% Markdown support
\ifthenelse{\boolean{regulatory@usemarkdown}}{
\RequirePackage[hashEnumerators,definitionLists,hybrid,headerAttributes=true]{markdown}
\def\@uitlijning{Lorem ipsum dolor sit amet.}%
\newcommand{\uitlijning}[1]{\def\@uitlijning{#1}}%
\setkeys{markdownRenderers}{
headingOne={\artikel{#1}},
olItemWithNumber={\item{}},
olBeginTight={\begin{leden}},
olEndTight={\end{leden}},
olBegin={\begin{leden}},
olEnd={\end{leden}},
dlBeginTight={\begin{labeling}{\@uitlijning}},
dlEndTight={\end{labeling}},
dlBegin={\begin{labeling}{\@uitlijning}},
dlEnd={\end{labeling}}%
\renewcommand\markdownRendererOlItemWithNumber[1]{\item{}\label{ml:##1}}
}
}{}

% Pakketten nÃ¡ markdown (anders gaat enumitem kapot)
\RequirePackage{xcolor}
\RequirePackage{xassoccnt}
\RequirePackage{xpatch}
\RequirePackage{titlesec} % voor artikelen
\RequirePackage{enumitem} % voor leden/subleden
\RequirePackage{fmtcount} % voor tekstuele leden
\RequirePackage{scrextend} % voor definitie lijsten
\RequirePackage[hidelinks]{hyperref}
\RequirePackage[user,counter,hyperref]{zref}
\RequirePackage{cleveref}

%\RequirePackage[dutch]{cleveref} % voor verwijzingen


% Kleuren
\colorlet{artlabel}{black}
\colorlet{arttitle}{black}
\colorlet{lidlabel}{black}
\colorlet{lidtitle}{black}
\colorlet{sublabel}{black}
\colorlet{subtitle}{black}


% Artikelen
\newcounter{artikel}
\titleclass{\artikel}{straight}[\part]
\titleformat{\artikel}{\normalfont\color{arttitle}}{\bfseries\color{artlabel}Artikel \theartikel.\quad}{1em}{}
\titlespacing*{\artikel}{0pt}{3.5ex plus 1ex minus .2ex}{5pt}

\newcounter{lid}
\titleclass{\lid}{straight}[\part]
\titleformat{\lid}{\normalfont\color{lidtitle}}{\normalfont\color{lidlabel}\theartikel.\thelid.\quad}{1em}{}
\titlespacing*{\lid}{0pt}{3.5ex plus 1ex minus .2ex}{5pt}
\counterwithin{lid}{artikel}

\renewcommand{\theartikel}{\arabic{artikel}}
\renewcommand{\thelid}{\arabic{lid}}
\makeatletter
\newcommand{\l@artikel}{\@dottedtocline{1}{1.5em}{2.3em}}
\def\toclevel@artikel{2}
\newcommand{\l@lid}{\@dottedtocline{1}{3.8em}{2.3em}}
\def\toclevel@lid{3}
\makeatother

% Leden en subleden
\newlist{leden}{enumerate}{2}
\setlist[leden,1]{label=\theartikel.\arabic*.,ref=\arabic*,align=left,itemsep=0pt}
\setlist[leden,2]{label=\abalphnum{\arabic*}),ref=\arabic*,itemsep=0pt}
\counterwithin{ledeni}{artikel}
\counterwithin{ledenii}{ledeni}

% Verwijzingsnaam naar leden en subleden (lid/sub)
\crefname{artikel}{artikel}{artikelen}
\crefname{lid}{lid\unskip}{leden\unskip}
\crefname{ledeni}{lid\unskip}{leden\unskip}
\crefname{ledenii}{onderdeel\unskip}{onderdelen\unskip}


% Schakelbepalingen
\RequirePackage{xr}
\RequirePackage{attachfile}
\makeatletter
\newcommand*{\addFileDependency}[1]{% argument=file name and extension
\typeout{(#1)}
\@addtofilelist{#1}
\IfFileExists{#1}{}{\typeout{No file #1.}}
}

\makeatother
\newcommand{\extdoc}[2][ext-]{%
\externaldocument[#1]{../../#2/out/main}%
\addFileDependency{../../#2/src/main.tex}%
\addFileDependency{../../#2/out/main.aux}%
}

\makeatletter

\zref@newprop{artikel}[-1]{\number\value{artikel}}
\zref@newprop{lid}[-1]{\ifnum\value{lid}>0\number\value{lid}\else\number\value{ledeni}\fi}
\zref@newprop{sub}[-1]{\number\value{ledenii}}
\zref@addprops{main}{artikel,lid,sub}

\newcommand{\artnum}[1]{%
\zref@extract{#1}{artikel}%
}

\newcommand{\artformat}[1]{%
\cref@artikel@name~#1%
}

\newcommand{\Artformat}[1]{%
\Cref@artikel@name~#1%
}

\newcommand{\lidnum}[1]{%
\zref@extract{#1}{lid}%
}

\newcommand{\lidformat}[1]{%
\ordinalstringnum{#1}~\cref@ledeni@name%
}

\newcommand{\Lidformat}[1]{%
\Ordinalstringnum{#1}~\cref@ledeni@name%
}

\newcommand{\lidprefix}[2]{%
\ifnum\artnum{#1}=\value{artikel}%
\cref{#2}, van dit artikel%
\else%
\artformat{\artnum{#1}}, \cref{#2}%
\fi%
}

\newcommand{\subnum}[1]{%
\zref@extract{#1}{sub}%
}

\newcommand{\subformat}[1]{%
\cref@ledenii@name~\abalphnum{#1}%
}

\newcommand{\Subformat}[1]{%
\Cref@ledenii@name~\abalphnum{#1}%
}

\newcommand{\subprefix}[2]{%
\ifnum\artnum{#1}=\value{artikel}%
\ifnum\lidnum{#1}=\value{ledeni}%
\cref{#2} van dit lid%
\else%
\lidformat{\lidnum{#1}}, \cref{#2}, van dit artikel%
\fi%
\else%
\artformat{\artnum{#1}}, \lidformat{\lidnum{#1}}, \cref{#2}%
\fi%
}

\newcommand{\Subprefix}[2]{%
\ifnum\artnum{#1}=\value{artikel}%
\ifnum\lidnum{#1}=\value{ledeni}%
\Cref{#2} van dit lid%
\else%
\Lidformat{\lidnum{#1}}, \cref{#2}, van dit artikel%
\fi%
\else%
\Artformat{\artnum{#1}}, \lidformat{\lidnum{#1}}, \cref{#2}%
\fi%
}

\newcommand{\aref}[1]{%
\IfSubStr{#1}{,}{%
\StrBefore[1]{#1}{,}[\firstarg]%
}{%
\def\firstarg{#1}%
}%
\ifthenelse{\equal{\zref@extract{\firstarg}{counter}}{ledeni}}{%
\lidprefix{\firstarg}{#1}%
}{%
\ifthenelse{\equal{\zref@extract{\firstarg}{counter}}{lid}}{%
\lidprefix{\firstarg}{#1}%
}{%
\ifthenelse{\equal{\zref@extract{\firstarg}{counter}}{ledenii}}{%
\subprefix{\firstarg}{#1}%
}{%
\cref{#1}%
}%
}%
}%
}

\newcommand{\Aref}[1]{%
\IfSubStr{#1}{,}{%
\StrBefore[1]{#1}{,}[\Firstarg]%
}{%
\def\Firstarg{#1}%
}%
\ifthenelse{\equal{\zref@extract{\Firstarg}{counter}}{ledeni}}{%
\Lidprefix{\Firstarg}{#1}%
}{%
\ifthenelse{\equal{\zref@extract{\Firstarg}{counter}}{lid}}{%
\Lidprefix{\Firstarg}{#1}%
}{%
\ifthenelse{\equal{\zref@extract{\Firstarg}{counter}}{ledenii}}{%
\Subprefix{\Firstarg}{#1}%
}{%
\Cref{#1}%
}%
}%
}%
}

% Cleveref formats
\crefformat{artikel}{#2\artformat{#1}#3}%
\Crefformat{artikel}{#2\Artformat{#1}#3}%
\crefrangeformat{artikel}{#3\cref@artikel@name@plural~#1#4 \crefrangeconjunction #5#2#6}%
\Crefrangeformat{artikel}{#3\Cref@artikel@name@plural~#1#4 \crefrangeconjunction #5#2#6}%
\crefmultiformat{artikel}{#2\cref@artikel@name@plural~#1#3}{\crefpairconjunction#2#1#3}{\crefmiddleconjunction#2#1#3}{\creflastconjunction#2#1#3}%
\Crefmultiformat{artikel}{#2\Cref@artikel@name@plural~#1#3}{\crefpairconjunction#2#1#3}{\crefmiddleconjunction#2#1#3}{\creflastconjunction#2#1#3}%

\crefformat{ledeni}{#2\lidformat{#1}#3}%
\Crefformat{ledeni}{#2\Lidformat{#1}#3}%
\crefrangeformat{ledeni}{#3\ordinalstringnum{#1}#4 \crefrangeconjunction #5\lidformat{#2}#6}%
\Crefrangeformat{ledeni}{#3\Ordinalstringnum{#1}#4 \crefrangeconjunction #5\lidformat{#2}#6}%
\crefmultiformat{ledeni}{#2\ordinalstringnum{#1}#3}{\crefpairconjunction #2\lidformat{#1}#3}{\crefmiddleconjunction#2\ordinalstringnum{#1}#3}{\creflastconjunction#2\lidformat{#1}#3}%
\Crefmultiformat{ledeni}{#2\Ordinalstringnum{#1}#3}{\crefpairconjunction #2\lidformat{#1}#3}{\crefmiddleconjunction#2\ordinalstringnum{#1}#3}{\creflastconjunction#2\lidformat{#1}#3}%

\crefformat{lid}{#2\lidformat{#1}#3}%
\Crefformat{lid}{#2\Lidformat{#1}#3}%
\crefrangeformat{lid}{#3\ordinalstringnum{#1}#4 \crefrangeconjunction #5\lidformat{#2}#6}%
\Crefrangeformat{lid}{#3\Ordinalstringnum{#1}#4 \crefrangeconjunction #5\lidformat{#2}#6}%
\crefmultiformat{lid}{#2\ordinalstringnum{#1}#3}{\crefpairconjunction #2\lidformat{#1}#3}{\crefmiddleconjunction#2\ordinalstringnum{#1}#3}{\creflastconjunction#2\lidformat{#1}#3}%
\Crefmultiformat{lid}{#2\Ordinalstringnum{#1}#3}{\crefpairconjunction #2\lidformat{#1}#3}{\crefmiddleconjunction#2\ordinalstringnum{#1}#3}{\creflastconjunction#2\lidformat{#1}#3}%

\crefformat{ledenii}{#2\subformat{#1}#3}%
\Crefformat{ledenii}{#2\Subformat{#1}#3}%
\crefrangeformat{ledenii}{#3\cref@ledenii@name@plural~\abalphnum{#1}#4 \crefrangeconjunction #5\abalphnum{#2}#6}%
\Crefrangeformat{ledenii}{#3\Cref@ledenii@name@plural~\abalphnum{#1}#4 \crefrangeconjunction #5\abalphnum{#2}#6}%
\crefmultiformat{ledenii}{#2\cref@ledenii@name@plural~\abalphnum{#1}#3}{\crefpairconjunction#2\abalphnum{#1}#3}{\crefmiddleconjunction#2\abalphnum{#1}#3}{\creflastconjunction#2\abalphnum{#1}#3}%
\Crefmultiformat{ledenii}{#2\Cref@ledenii@name@plural~\abalphnum{#1}#3}{\crefpairconjunction#2\abalphnum{#1}#3}{\crefmiddleconjunction#2\abalphnum{#1}#3}{\creflastconjunction#2\abalphnum{#1}#3}%

\GetAllResetLists
\RegisterPostLabelHook{\zlabel}

\makeatother
