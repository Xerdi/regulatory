\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{regulatory}[2022/06/19 Xerdi's Regulatory Package]

\RequirePackage{xifthen}
\RequirePackage{keyval}
\RequirePackage{xstring}
\RequirePackage{xspace}

\newboolean{regulatory@usemarkdown}
\setboolean{regulatory@usemarkdown}{false}
\DeclareOption{markdown}{%
    \setboolean{regulatory@usemarkdown}{true}%
}

\newboolean{regulatory@usebib2gls}
\setboolean{regulatory@usebib2gls}{true}
\DeclareOption{bibdefs}{\setboolean{regulatory@usebib2gls}{true}}
\DeclareOption{nobibdefs}{\setboolean{regulatory@usebib2gls}{false}}

\DeclareOption{hidelinks}{%
    \PassOptionsToPackage{hidelinks}{hyperref}}

\newboolean{regulatory@nameinlink}
\setboolean{regulatory@nameinlink}{true}

\newboolean{regulatory@alldefs}
\setboolean{regulatory@alldefs}{false}
\DeclareOption{alldefs}{\setboolean{regulatory@alldefs}{true}}

\newboolean{regulatory@usejuncto}
\setboolean{regulatory@usejuncto}{false}
\DeclareOption{juncto}{%
    \setboolean{regulatory@usejuncto}{true}}

\DeclareOption*{\PackageError{regulatory}{Unknown option}{Options are markdown,bibdefs,nobibdefs,alldefs,hidelinks}}
\ProcessOptions*

% Markdown support
\ifthenelse{\boolean{regulatory@usemarkdown}}{
\RequirePackage[hashEnumerators,definitionLists,hybrid,headerAttributes=true]{markdown}
\setkeys{markdownRenderers}{
headingOne={\article{#1}},
olItemWithNumber={\item{}},
olBeginTight={\begin{paras}},
olEndTight={\end{paras}},
olBegin={\begin{paras}},
olEnd={\end{paras}},
dlBeginTight={\begin{labeling}{\@glswidestname}},
dlEndTight={\end{labeling}},
dlBegin={\begin{labeling}{\@glswidestname}},
dlEnd={\end{labeling}}%
\renewcommand\markdownRendererOlItemWithNumber[1]{\item{}\label{ml:##1}}
}
}{}

% Pakketten nÃ¡ markdown (anders gaat enumitem kapot)
\RequirePackage{xcolor}
\RequirePackage{xassoccnt}
\RequirePackage{xpatch}
\RequirePackage[loadonly]{titlesec}
\RequirePackage{enumitem}
\RequirePackage{fmtcount}
\RequirePackage{scrextend}
\RequirePackage{xr-hyper}
\RequirePackage{hyperref}
\RequirePackage[user,counter,hyperref,xr]{zref}
\RequirePackage{zref-xr,zref-user,zref-clever,zref-hyperref}
\RequirePackage{pgf}
%\RequirePackage{suffix}
\RequirePackage[sanitize=none,nopostdot]{glossaries}
\ifthenelse{\boolean{regulatory@usebib2gls}}{%
    \RequirePackage[record,style=alttree]{glossaries-extra}
}{%
    \PackageWarning{regulatory}{Using glossaries for definitions without bib2gls. This is mostly untested.}
}
\RequirePackage{attachfile2}
\RequirePackage{translations}

\newboolean{regulatory@defslisted}
\setboolean{regulatory@defslisted}{false}

% Kleuren
\colorlet{artlabel}{black}
\colorlet{arttitle}{black}
\colorlet{paralabel}{black}
\colorlet{paratitle}{black}
\colorlet{sublabel}{black}
\colorlet{subtitle}{black}


% Artikelen
\newcounter{article}
\titleclass{\article}[0]{straight}
\titleformat{\article}{\normalfont\color{arttitle}}{\bfseries\color{artlabel}Artikel \thearticle.\quad}{1em}{}
\titlespacing*{\article}{0pt}{3.5ex plus 1ex minus .2ex}{5pt}

\newcounter{para}
\titleclass{\para}{straight}[\article]
\titleformat{\para}{\normalfont\color{paratitle}}{\normalfont\color{paralabel}\thearticle.\thepara.\quad}{1em}{}
\titlespacing*{\para}{0pt}{3.5ex plus 1ex minus .2ex}{5pt}
\counterwithin{para}{article}

\renewcommand{\thearticle}{\arabic{article}}
\renewcommand{\thepara}{\arabic{para}}
\makeatletter
\newcommand{\l@article}{\@dottedtocline{1}{1.5em}{2.3em}}
\def\toclevel@article{2}
\newcommand{\l@para}{\@dottedtocline{1}{3.8em}{2.3em}}
\def\toclevel@para{3}

\newlist{paras}{enumerate}{2}
\setlist[paras,1]{label=\thearticle.\arabic*.,ref=\arabic*,align=left,itemsep=0pt}
\setlist[paras,2]{label=\abalphnum{\arabic*}),ref=\arabic*,itemsep=0pt}
\counterwithin{parasi}{article}
\counterwithin{parasii}{parasi}

\zref@newprop{article}[-1]{\number\value{article}}
\zref@newprop{para}[-1]{\ifnum\value{para}>0\number\value{para}\else\number\value{parasi}\fi}
\zref@newprop{sub}[-1]{\number\value{parasii}}
\zref@addprops{main}{article,para,sub}

\DeclareTranslationFallback{article}{article}
\DeclareTranslationFallback{paragraph}{paragraph}
\DeclareTranslationFallback{subparagraph}{subparagraph}
\DeclareTranslation{dutch}{article}{artikel}
\DeclareTranslation{dutch}{paragraph}{lid}
\DeclareTranslation{dutch}{subparagraph}{onderdeel}
\DeclareTranslation{dutch}{Article}{Artikel}
\DeclareTranslation{dutch}{Paragraph}{Lid}
\DeclareTranslation{dutch}{Subparagraph}{Onderdeel}
\DeclareTranslation{dutch}{to}{tot}

\zcRefTypeSetup{article}{%
    Name-sg = \GetTranslation{Article},
    name-sg = \GetTranslation{article},
    Name-pl = Artikelen,
    name-pl = artikelen
}
\zcRefTypeSetup{para}{%
    Name-sg = \GetTranslation{Paragraph},
    name-sg = \GetTranslation{paragraph},
    Name-pl = Leden,
    name-pl = leden
}
\zcRefTypeSetup{parasi}{%
    Name-sg = \GetTranslation{Paragraph},
    name-sg = \GetTranslation{paragraph},
    Name-pl = Leden,
    name-pl = leden
}
\zcRefTypeSetup{parasii}{%
    Name-sg = \GetTranslation{Subparagraph},
    name-sg = \GetTranslation{subparagraph},
    Name-pl = Onderdelen,
    name-pl = onderdelen
}

\makeatother
{\catcode`\#=12 \gdef\hashchar{#}}
\makeatletter
\newcommand\@aref@hl[1]{\edef\next{%
    \noexpand\href{\@aref@fullurl}{#1}}\next}
%\newcommand\rref@mklink[2]{\edef\next{%
%    \noexpand\href{#1}{#2}}\next}
\def\rref@linkpr{\href{\rref@current@fullurl}}

\newboolean{rref@cap}
\def\@ifrrefcap#1#2{%
    \ifthenelse{\boolean{rref@cap}}{%
        #1%
        \ifthenelse{\equal{#1}{}}{}{%
            \setboolean{rref@cap}{false}%
        }%
    }{%
        #2%
    }%
}
\def\@ifnameinlink#1#2{%
    \ifthenelse{\boolean{regulatory@nameinlink}}{#1}{#2}%
}

\newcommand\rref@middleconjunction{, }
\newcommand\rref@lastconjunction{ \GetTranslation{and} }
\newcommand\rref@rangeconjunction{ \GetTranslation{to} }

\newcommand\setmiddleconjunction[1]{\renewcommand\rref@middleconjunction{#1}}
\newcommand\setlastconjunction[1]{\renewcommand\rref@lastconjunction{#1}}
\newcommand\setrangeconjunction[1]{\renewcommand\rref@rangeconjunction{#1}}

\newcommand\setconjunction[3]{%
    \setmiddleconjunction{#1}%
    \setlastconjunction{#1}%
    \setrangeconjunction{#1}%
}

\newcommand\setjuncto{%
\setlastconjunction{ jo.\ }%
}

\newcommand\unsetjuncto{%
\setlastconjunction{ \GetTranslation{and} }%
}

\ifthenelse{\boolean{regulatory@usejuncto}}{\setjuncto}{}

\newcommand\rref@refformat@noop[1]{#1}
\newcommand\rref@refformat@parenthesis[1]{(#1)}
\newcommand\rref@refformat@ordinal[1]{\@ifrrefcap{\Ordinalstringnum{#1}}{\ordinalstringnum{#1}}}
\newcommand\rref@refformat@alpha[1]{\@ifrrefcap{\ABAlphnum{#1}}{\abalphnum{#1}}}
\newcommand\rref@label@prefix[2]{#1 #2}
\newcommand\rref@label@postfix[2]{#2 #1}
\newcommand\rref@label@refonly[2]{\@gobble{#1}#2}

% English full format layout (default)
%\newcommand\rref@fullformat@article[2]{#1#2}
%\newcommand\rref@fullformat@para[3]{#1#2#3}
%\newcommand\rref@fullformat@sub[4]{[#1#2, #3]#4}

% Dutch full format layout
%\newcommand\rref@fullformat@nl@para[3]{#1, #2#3}
%\newcommand\rref@fullformat@nl@sub[4]{#1, #2, #3#4}

\newcommand\rref@init@lang@article[1]{%
    \pgfkeys{/rref/#1/article/.is family,
        /rref/#1/article,
        name/.initial=\GetTranslation{article},
        Name/.initial=\GetTranslation{Article},
        ref format/.initial=\rref@refformat@noop,
        label format/.initial=\rref@label@prefix
    }
}
\newcommand\rref@init@lang@para[1]{%
    \pgfkeys{/rref/#1/para/.is family,
        /rref/#1/para,
        name/.initial=\GetTranslation{paragraph},
        Name/.initial=\GetTranslation{Paragraph},
        ref format/.initial=\rref@refformat@parenthesis,
        label format/.initial=\rref@label@refonly
    }
}
\newcommand\rref@init@lang@sub[1]{%
    \pgfkeys{/rref/#1/sub/.is family,
        /rref/#1/sub,
        name/.initial=\GetTranslation{subparagraph},
        Name/.initial=\GetTranslation{Subparagraph},
        ref format/.initial=\rref@refformat@ordinal,
        label format/.initial=\rref@label@postfix
    }
}

\newcommand\rref@setup@lang[3]{%
    \pgfkeys{/rref/#1/#2,#3}
}

\newcommand\rref@setup[4]{%
    \rref@init@lang@article{#1}
    \rref@init@lang@para{#1}
    \rref@init@lang@sub{#1}
    \rref@setup@lang{#1}{article}{#2}
    \rref@setup@lang{#1}{para}{#3}
    \rref@setup@lang{#1}{sub}{#4}
}

% The default are already based on English, so no arguments are given.
\rref@setup{english}{}{}{}

\rref@setup{dutch}{}{
    ref format=\rref@refformat@ordinal,
    label format=\rref@label@postfix
}{
    ref format=\rref@refformat@alpha,
    label format=\rref@label@prefix
}%

\newcommand\rref@set[4][\languagename]{%
    \pgfkeysgetvalue{/rref/#1/#2/#3}{#4}%
}

\newcommand\rref@get[3][\languagename]{%
    \pgfkeysvalueof{/rref/#1/#2/#3}%
}

\newcommand\rref@name[2][\languagename]{\@ifrrefcap{\rref@get[#1]{#2}{Name}}{\rref@get[#1]{#2}{name}}}
\def\rref@article@name{\rref@name{article}}
\def\rref@para@name{\rref@name{para}}
\def\rref@sub@name{\rref@name{sub}}

\newcommand\rref@refformat[2][\rref@current@type]{\rref@set{#1}{ref format}{\@@rrefformat}\@@rrefformat{#2}}
\newcommand\rref@labelformat[2][\rref@current@type]{\rref@set{#1}{label format}{\@@labelformat}\@@labelformat{\rref@name{#1}}{#2}}
\newcommand\rref@linkformat[2][\rref@current@type]{%
    \@ifnameinlink{%
        \rref@linkpr{\rref@labelformat[#1]{\rref@refformat[#1]{#2}}}%
    }{%
        \rref@labelformat[#1]{\rref@linkpr{\rref@refformat[#1]{#2}}}%
    }%
}
\newcommand\rref@reflink[2][\rref@current@type]{%
    \rref@linkpr{\rref@refformat[#1]{#2}}%
}

%\newcommand\rref@unstarred[1]{#1}
%\newcommand\rref@starred[1]{#1}
%
%\newcommand\newrrefcmd[3]{%
%    \expandafter\newcommand\csname #1\endcsname{%
%        \@ifstar{\rref@starred{#2}}{\rref@unstarred{#3}}%
%    }%
%}

\def\rref{\@ifstar\rref@star\rref@nostar}
\def\rref@star#1{%
    \rref@setcurrent{#1}%
    \ifnum\rref@current@value>0%
        \rref@refformat{\rref@current@value}%
    \else%
        \zref{#1}%
    \fi%
}
\def\rref@nostar#1{%
    \rref@setcurrent{#1}%
    \ifnum\rref@current@value>0%
        \rref@linkpr{\rref@refformat{\rref@current@value}}%
    \else%
        \zcref[noname]{#1}%
    \fi%
}
\def\Rref{\@ifstar\Rref@star\Rref@nostar}
\def\Rref@star#1{%
    \setboolean{rref@cap}{true}%
    \rref*{#1}%
}
\def\Rref@nostar#1{%
    \setboolean{rref@cap}{true}%
    \rref{#1}%
}

\def\nref{\@ifstar\nref@star\nref@nostar}
\def\nref@star#1{%
    \rref@setcurrent{#1}%
    \ifnum\rref@current@value>0%
        \rref@labelformat{\rref@refformat{\rref@current@value}}%
    \else%
        \zcref*{#1}%
    \fi%
}
\def\nref@nostar#1{%
    \rref@setcurrent{#1}%
    \ifnum\rref@current@value>0%
        \rref@linkformat{\rref@current@value}%
    \else%
        \zcref{#1}%
    \fi%
}
\def\Nref{\@ifstar\Nref@star\Nref@nostar}
\def\Nref@star#1{%
    \setboolean{rref@cap}{true}%
    \nref*{#1}%
}
\def\Nref@nostar#1{%
    \setboolean{rref@cap}{true}%
    \nref{#1}%
}

\def\rref@setcurrent#1{%
    \def\rref@current{#1}%
    \def\rref@current@counter{\zref@extract{#1}{counter}}%
    \def\rref@current@article{\zref@extract{#1}{article}}%
    \def\rref@current@para{\zref@extract{#1}{para}}%
    \def\rref@current@sub{\zref@extract{#1}{sub}}%
    \rref@settype%
    \rref@setlink%
}
\def\rref@settype{%
    \ifthenelse{\equal{article}{\rref@current@counter}}{%
        \def\rref@current@type{article}%
        \def\rref@current@value{\rref@current@article}%
        \def\rref@current@fullformat{}
    }{%
        \ifthenelse{\equal{para}{\rref@current@counter}\or\equal{parasi}{\rref@current@counter}}{%
            \def\rref@current@type{para}%
            \def\rref@current@value{\rref@current@para}%
        }{%
            \ifthenelse{\equal{parasii}{\rref@current@counter}}{%
                \def\rref@current@type{sub}%
                \def\rref@current@value{\rref@current@sub}%
            }{%
                \def\rref@current@type{}%
                \def\rref@current@value{-1}%
            }%
        }%
    }%
}
\def\rref@setlink{%
    \def\rref@current@anchor{\zref@extract{\rref@current}{anchor}}%
    \def\rref@current@url{\zref@extractdefault{\rref@current}{url}{}}%
    \def\rref@current@fullurl{\rref@current@url\hashchar\rref@current@anchor}%
}
\newcommand\rref@number[1]{%
    \zref@extractdefault{#1}{\rref@current@type}{-1}%
}

% Artikel labels
\def\@aref@article@prefix{\rref@article@name~}
\def\@Aref@article@prefix{\rref@article@name~} % deprecated
\def\@aref@article@postfix{}
%\def\@aref@article@format{\rref@refformat[article]{\@aref@article}}
\def\@aref@article@format{\@aref@article}
\def\@aref@article@formathl{\@aref@hl{\@aref@article@format}}
\def\@aref@article@nformat{\@aref@article@prefix\@aref@article}
\def\@Aref@article@nformat{\@Aref@article@prefix\@aref@article} % deprecated
\def\@aref@article@nformathl{\@aref@article@prefix\@aref@article@formathl}
\def\@Aref@article@nformathl{\@Aref@article@prefix\@aref@article@formathl} % deprecated


% Lid labels
\def\@aref@para@prefix{}
\def\@Aref@para@prefix{} % deprecated
\def\@aref@para@postfix{~\rref@para@name}
%\def\@aref@para@format{\rref@labelformat{para}{\rref@para@name}{\rref@refformat{para}{\@aref@para}}}%\ordinalstringnum{\@aref@para}}
%\def\@aref@para@format{\rref@refformat[para]{\@aref@para}}
\def\@aref@para@format{\ordinalstringnum{\@aref@para}}
\def\@Aref@para@format{\Ordinalstringnum{\@aref@para}} % deprecated
\def\@aref@para@formathl{\@aref@hl{\@aref@para@format}}
\def\@Aref@para@formathl{\@aref@hl{\@Aref@para@format}} % deprecated
\def\@aref@para@nformat{\@aref@para@format\@aref@para@postfix}
\def\@aref@para@nformathl{\@aref@para@formathl\@aref@para@postfix}
\def\@Aref@para@nformat{\@Aref@para@format\@aref@para@postfix} % deprecated
\def\@Aref@para@nformathl{\@Aref@para@formathl\@aref@para@postfix} % deprecated

% Sub labels
\def\@aref@sub@prefix{\rref@sub@name~}
\def\@Aref@sub@prefix{\rref@sub@name~} % deprecated
\def\@aref@sub@postfix{}
\def\@aref@sub@format{\abalphnum{\@aref@sub}}
\def\@aref@sub@formathl{\@aref@hl{\@aref@sub@format}}
\def\@aref@sub@nformat{\@aref@sub@prefix\@aref@sub@format}
\def\@aref@sub@nformathl{\@aref@sub@prefix\@aref@sub@formathl}
\def\@Aref@sub@nformat{\@Aref@sub@prefix\@aref@sub@format} % deprecated
\def\@Aref@sub@nformathl{\@Aref@sub@prefix\@aref@sub@formathl} % deprecated

\def\@ifartifactisset#1#2#3{%
    \pgfkeysifdefined{/artifact/#1/.is family}{#2}{#3}%
}

\newcommand\@aref@setvars[1]{%
    \def\@aref@count{\zref@extract{#1}{counter}}%
    \def\@aref@article{\zref@extract{#1}{article}}%
    \def\@aref@para{\zref@extract{#1}{para}}%
    \def\@aref@sub{\zref@extract{#1}{sub}}%
    \def\@aref@anchor{\zref@extract{#1}{anchor}}%
    \def\@aref@url{\zref@extractdefault{#1}{url}{}}%
    \def\@aref@fullurl{\@aref@url\hashchar\@aref@anchor}%
    \zref@ifrefcontainsprop{#1}{externaldocument}{%
        \def\@aref@filelabel{\zref@extract{#1}{externaldocument}}%
        \def\@aref@postlink{%
            \ifthenelse{\equal{\artifactfootnote{\@aref@filelabel}}{true}\and\equal{\artifactreferred{\@aref@filelabel}}{false}}{%
                \reffootnotelabel{\@aref@filelabel}%
            }{}%
        }%
    }{%
        \def\@aref@postlink{}%
    }%
    \ifthenelse{\equal{\@aref@count}{article}}{%
        \def\@aref@type{article}%
        \def\@aref@value{\@aref@article}%
        \def\@aref@format{\@aref@article@formathl}%
        \def\@aref@formatn{\@ifacap{\@Aref@article@prefix}{\@aref@article@prefix}\@aref@format}%
        \def\@aref@prefix{\@ifacap{\@Aref@article@prefix}{\@aref@article@prefix}}%
        \def\@aref@postfix{}%
    }{%
        \ifthenelse{\equal{\@aref@count}{parasi}\OR\equal{\@aref@count}{para}}{%
            \def\@aref@type{para}%
            \def\@aref@value{\@aref@para}%
%            \ifthenelse{\boolean{regulatory@nameinlink}}{%
%                \def\@aref@format{\@aref@hl{\rref@labelformat{para}{\rref@refformat{para}{\@aref@para}}}}%
%            }{%
%                \def\@aref@format{\@aref@hl{\rref@labelformat{para}{\rref@refformat{para}{\@aref@para}}}}%
%            }%
%            \def\@aref@format{\rref@linkformat{para}{\@aref@para}}%%\@ifacap{\@Aref@para@formathl}{\@aref@para@formathl}}%
%            \def\@aref@format{\@aref@hl{\rref@refformat{para}{\@aref@para}}}%%\@ifacap{\@Aref@para@formathl}{\@aref@para@formathl}}%
%            \def\@aref@format{\rref@labelformat{para}{\@aref@para}}%%\@ifacap{\@Aref@para@formathl}{\@aref@para@formathl}}%
            \def\@aref@format{\@ifacap{\@Aref@para@formathl}{\@aref@para@formathl}}%
            \def\@aref@formatn{\@aref@format\@aref@para@postfix}%
            \def\@aref@prefix{%
                \@ifacap{\@Aref@article@prefix}{\@aref@article@prefix}\@aref@article@format,~%
            }%
            \def\@aref@postfix{\@aref@para@postfix}%
        }{%
            \ifthenelse{\equal{\@aref@count}{parasii}}{%
                \def\@aref@type{sub}%
                \def\@aref@value{\@aref@sub}%
                \def\@aref@format{\@aref@sub@formathl}%
                \def\@aref@prefix{%
                    \@ifacap{\@Aref@article@prefix}{\@aref@article@prefix}\@aref@article@format,~%
                    \@ifacap{\@Aref@para@format}{\@aref@para@format}\@aref@para@postfix,~%
                    \@ifacap{\@Aref@sub@prefix}{\@aref@sub@prefix}%
                }%
                \def\@aref@postfix{}%
            }{%
                \def\@aref@type{page}%
                \def\@aref@format{??}%
                \def\@aref@prefix{}%
                \def\@aref@postfix{}%
            }%
        }%
    }%
    \def\@aref@number##1{\zref@extractdefault{##1}{\@aref@type}{-1}}%
}

% TODO: deprecated
\newboolean{aref@cap}
\def\@ifacap#1#2{\ifthenelse{\boolean{aref@cap}}{#1\setboolean{aref@cap}{false}}{#2}}

\newcommand{\aref}[1]{%
    \IfSubStr{#1}{,}{%
        \StrBefore[1]{#1}{,}[\firstarg]%
    }{%
        \def\firstarg{#1}%
    }%
    \rref@setcurrent{\firstarg}%
    \@aref@setvars{\firstarg}%% TODO: deprecated
    \@aref@prefix\aref@group{#1}\@aref@postfix\@aref@postlink%
}

\newcommand{\Aref}[1]{%
    \setboolean{aref@cap}{true}%
    \aref{#1}%
%    \IfSubStr{#1}{,}{%
%        \StrBefore[1]{#1}{,}[\Firstarg]%
%    }{%
%        \def\Firstarg{#1}%
%    }%
%    \@aref@setvars{\Firstarg}%% TODO: deprecated
%    \@aref@prefix\aref@group{#1}\@aref@postfix\@aref@postlink%
}

\def\listterminator{-1}

\newcommand\aref@group[1]{%
    \bubblesort{#1}%
    \expandafter\begincompaction\sortedlist,\listterminator,\relax%
}
\def\begincompaction#1,#2\relax{%
    \def\startlist{#1}%
    \def\currentendlist{#1}%
    \findendlist#2\relax%
}
\def\findendlist#1,#2\relax{%
    \rref@setcurrent{#1}%
    \@aref@setvars{#1}% TODO: depracated
    \ifnum\numexpr\@aref@number{\currentendlist}+1\relax=\@aref@number{#1}\relax%
        \def\currentendlist{#1}%
        \findendlist#2\relax%
    \else%
        \rref@setcurrent{\startlist}%
        \@aref@setvars{\startlist}% TODO: deprecated
        \ifnum\@aref@number{\startlist}=\@aref@number{\currentendlist}\relax%
            \ignorespaces\@aref@format\unskip%
        \else%
            \ifnum\numexpr\@aref@number{\startlist}+1\relax=\@aref@number{\currentendlist}\relax%
                \ignorespaces\@aref@format\unskip%
                \ifnum\@aref@number{#1}=\listterminator\relax%
                    \rref@lastconjunction%
                \else%
                    \rref@middleconjunction%
                \fi\ignorespaces%
                \rref@setcurrent{\currentendlist}%
                \@aref@setvars{\currentendlist}% TODO: deprecated
                \@aref@format\unskip%
            \else%
                \ignorespaces\@aref@format\unskip\rref@rangeconjunction\ignorespaces%
                \rref@setcurrent{\currentendlist}%
                \@aref@setvars{\currentendlist}% TODO: deprecated
                \@aref@format\unskip%
            \fi%
        \fi%
        \ifnum\@aref@number{#1}=\listterminator\else%
            \IfStrEq{#2}{\listterminator,}{\rref@lastconjunction}{\rref@middleconjunction}\begincompaction#1,#2\relax%
        \fi%
    \fi%
}
\newcommand\bubblesort[1]{\def\sortedlist{}\sortlist#1,\listterminator,\relax}
\def\sortlist#1,#2,#3\relax{%
    \rref@setcurrent{#1}%
    \@aref@setvars{#1}% TODO: deprecated
    \ifnum\@aref@number{#2}=\listterminator\relax%
        \edef\sortedlist{\sortedlist#1}%
    \else%
        \ifnum\@aref@number{#1}<\@aref@number{#2}\relax%
            \edef\sortedlist{\sortedlist#1,}%
            \sortlist#2,#3\relax%
        \else%
            \let\tmp\sortedlist%
            \def\sortedlist{}%
            \expandafter\sortlist\tmp#2,#1,#3\relax%
        \fi%
    \fi%
}

\GetAllResetLists
\RegisterPostLabelHook{\zlabel}

\newglossary*{definitions}{Definitions}
\newglossary*{externals}{Externals}


\newcommand\newartifact[2]{%
    \pgfkeys{
        /artifact/#1/.is family,
        /artifact/#1,
        name/.initial = #1,
        filename/.initial = #1.pdf,
        footnote/.initial = true,
        url/.initial=,
        referred/.initial = false,
        defs/.initial=,
        author/.initial=<author>,
        subject/.initial=<subject>,
        description/.initial=<description>
    }
    \pgfkeys{/artifact/#1,#2}
}
\newcommand\@aget[2]{\pgfkeysvalueof{/artifact/#1/#2}}
\newcommand\artifactname[1]{\@aget{#1}{name}}
\newcommand\artifactfilename[1]{\@aget{#1}{filename}}
\newcommand\artifactfootnote[1]{\@aget{#1}{footnote}}
\newcommand\artifacturl[1]{\@aget{#1}{url}}
\newcommand\artifactreferred[1]{\@aget{#1}{referred}}
\newcommand\artifactdefs[1]{\@aget{#1}{defs}}
\newcommand\artifactauthor[1]{\@aget{#1}{author}}
\newcommand\artifactsubject[1]{\@aget{#1}{subject}}
\newcommand\artifactdescription[1]{\@aget{#1}{description}}

\newcommand\describe[1]{\setboolean{regulatory@defslisted}{true}\glstarget{#1}{\glsentrydesc{#1}}}
\newcommand\printdefs[1]{%
    \renewcommand{\glossarysection}[2][]{}%
    \renewcommand*{\glsnamefont}[1]{\textmd{#1}}%
    \setboolean{regulatory@defslisted}{true}%
    \glssetwidest{#1\quad}%
    \ifthenelse{\boolean{regulatory@usebib2gls}}{\printunsrtglossary[type=definitions,style=alttree,title={},nonumberlist=true]}{\printglossary[type=definitions,style=alttree,title={},nonumberlist=true]}}

\attachfilesetup{color=black}

\newcommand\reffootnotelabel[1]{%
\pgfkeys{/artifact/#1,referred=true}%
\def\@tmpfile{\artifactfilename{#1}}%
, van \artifactsubject{#1}\footnote{Bijlage: \textattachfile[description={\artifactdescription{#1}},subject={\artifactsubject{#1}},author={\artifactauthor{#1}}]{\@tmpfile}{\@tmpfile}}%
}

\newcommand\deffootnotelabel[1]{%
    \pgfkeys{/artifact/#1,referred=true}%
    \def\@tmpfile{\artifactfilename{#1}}%
    ~(zie \artifactsubject{#1}\footnote{Bijlage: \textattachfile[description={\artifactdescription{#1}},subject={\artifactsubject{#1}},author={\artifactauthor{#1}}]{\@tmpfile}{\@tmpfile}})%
}

\edef\@regulatory@bib@selection{}
\ifthenelse{\boolean{regulatory@alldefs}}{\edef\@regulatory@bib@selection{,selection=all}}{}

\newcommand\loadglsdefs[1]{%
    \setboolean{regulatory@defslisted}{true}%
    \ifthenelse{\boolean{regulatory@usebib2gls}}{%
        \GlsXtrLoadResources[type=definitions,src={#1},sort={nl-NL},category={defs}\@regulatory@bib@selection]%
    }{%
        \loadglsentries[definitions]{#1}%
    }%
}

\newcommand\loadextdefs[2][externals]{%
    \ifthenelse{\boolean{regulatory@usebib2gls}}{%
        \GlsXtrLoadResources[type=externals,src={#2},sort={nl-NL},category={#1}]%
    }{%
        \loadglsentries[externals]{#2}%
    }%
    \glsdefpostlink{#1}{%
        \ifthenelse{\equal{\artifactreferred{#1}}{true}}{}{%
            \deffootnotelabel{#1}%
        }%
    }%
}

\newcommand\refdocument[2][ext-]{%
    \newartifact{#2}{footnote=false}%
    \zexternaldocument[#1]{#2}%
}

\newcommand\masterdocument[3][ext-]{%
    \newartifact{#2}{#3}%
    \zexternaldocument[#1]{#2}%
    \ifthenelse{\equal{\string\artifactdefs{#2}}{}}{%
        \PackageWarning{regulatory}{No definitions given to the master document. \the\gls commands will therefore not work.}%
    }{%
        \loadextdefs[#2]{\artifactdefs{#2}}%
        \ifthenelse{\boolean{regulatory@usebib2gls}}{%
            \glssetcategoryattribute{#2}{targeturl}{\artifactfilename{#2}}%
            \glssetcategoryattribute{#2}{targetname}{\glolinkprefix\glslabel}%
        }{}%
    }%
}

\AtEndPreamble{\ifthenelse{\boolean{regulatory@usebib2gls}}{}{\ifthenelse{\boolean{regulatory@defslisted}}{\makeglossaries}{}}}
\AtEndDocument{\ifthenelse{\boolean{regulatory@alldefs}}{\glsaddallunused}{}}
