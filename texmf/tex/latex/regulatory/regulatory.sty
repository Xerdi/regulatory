\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{regulatory}[2022/06/19 Xerdi's Regulatory Package]

\RequirePackage{xifthen}
\RequirePackage{keyval}
\RequirePackage{xstring}
\RequirePackage{xspace}

\newboolean{regulatory@usemarkdown}
\setboolean{regulatory@usemarkdown}{false}
\DeclareOption{markdown}{%
    \setboolean{regulatory@usemarkdown}{true}%
}

\newboolean{regulatory@usebib2gls}
\setboolean{regulatory@usebib2gls}{false}
\DeclareOption{bibdefs}{\setboolean{regulatory@usebib2gls}{true}}

\DeclareOption{hidelinks}{%
    \PassOptionsToPackage{hidelinks}{hyperref}}

\newboolean{regulatory@alldefs}
\setboolean{regulatory@alldefs}{false}
\DeclareOption{alldefs}{\setboolean{regulatory@alldefs}{true}}

% Verwijzingen koppelen met (standaard) , en afbreken met juncto (zie \setconjunction)
\newcommand{\crefpairconjunction}{ en~}
\newcommand{\creflastconjunction}{ en~}
\newcommand{\crefrangeconjunction}{tot~}

\newcommand\setjuncto{%
\renewcommand{\crefpairconjunction}{ jo.\ }%
\renewcommand{\creflastconjunction}{ jo.\ }%
}

\newcommand\unsetjuncto{%
\renewcommand{\crefpairconjunction}{ en~}%
\renewcommand{\creflastconjunction}{ en~}%
}

\DeclareOption{juncto}{%
    \setjuncto}

\DeclareOption*{\PackageError{regulatory}{Unknown option}{Options are markdown}}
%\ProcessOptionsX
\ProcessOptions*

\edef\@regulatory@bib@selection{}
\ifthenelse{\boolean{regulatory@alldefs}}{\edef\@regulatory@bib@selection{,selection=all}}{}

% Markdown support
\ifthenelse{\boolean{regulatory@usemarkdown}}{
\RequirePackage[hashEnumerators,definitionLists,hybrid,headerAttributes=true]{markdown}
\def\@uitlijning{Lorem ipsum dolor sit amet.}%
\newcommand{\uitlijning}[1]{\def\@uitlijning{#1}}%
\setkeys{markdownRenderers}{
headingOne={\artikel{#1}},
olItemWithNumber={\item{}},
olBeginTight={\begin{leden}},
olEndTight={\end{leden}},
olBegin={\begin{leden}},
olEnd={\end{leden}},
dlBeginTight={\begin{labeling}{\@uitlijning}},
dlEndTight={\end{labeling}},
dlBegin={\begin{labeling}{\@uitlijning}},
dlEnd={\end{labeling}}%
\renewcommand\markdownRendererOlItemWithNumber[1]{\item{}\label{ml:##1}}
}
}{}

% Pakketten nÃ¡ markdown (anders gaat enumitem kapot)
\RequirePackage{xcolor}
\RequirePackage{xassoccnt}
\RequirePackage{xpatch}
\RequirePackage{titlesec} % voor artikelen
\RequirePackage{enumitem} % voor leden/subleden
\RequirePackage{fmtcount} % voor tekstuele leden
\RequirePackage{scrextend} % voor definitie lijsten
\RequirePackage{xr-hyper}
\RequirePackage{hyperref} % voor linkjes
\RequirePackage[user,counter,hyperref]{zref} % voor verwijzingen
\RequirePackage{zref-xr,zref-user,zref-clever}
\RequirePackage{cleveref} % voor verwijzingen
\RequirePackage{pgf} % voor entities
\RequirePackage{suffix} % voor macro's met asterisk
\RequirePackage[sanitize=none,nonumberlist]{glossaries} % voor definitie lijsten

\newboolean{regulatory@defslisted}
\setboolean{regulatory@defslisted}{false}
% Glossary overrides
\setglossarystyle{alttree}
\renewcommand{\glossarysection}[2][]{}
\renewcommand*{\glsnamefont}[1]{\textmd{\textit{#1}}}
\renewcommand*{\glstextformat}{\textit}

% Kleuren
\colorlet{artlabel}{black}
\colorlet{arttitle}{black}
\colorlet{lidlabel}{black}
\colorlet{lidtitle}{black}
\colorlet{sublabel}{black}
\colorlet{subtitle}{black}


% Artikelen
\newcounter{artikel}
\titleclass{\artikel}{straight}[\part]
\titleformat{\artikel}{\normalfont\color{arttitle}}{\bfseries\color{artlabel}Artikel \theartikel.\quad}{1em}{}
\titlespacing*{\artikel}{0pt}{3.5ex plus 1ex minus .2ex}{5pt}

\newcounter{lid}
\titleclass{\lid}{straight}[\part]
\titleformat{\lid}{\normalfont\color{lidtitle}}{\normalfont\color{lidlabel}\theartikel.\thelid.\quad}{1em}{}
\titlespacing*{\lid}{0pt}{3.5ex plus 1ex minus .2ex}{5pt}
\counterwithin{lid}{artikel}

\renewcommand{\theartikel}{\arabic{artikel}}
\renewcommand{\thelid}{\arabic{lid}}
\makeatletter
\newcommand{\l@artikel}{\@dottedtocline{1}{1.5em}{2.3em}}
\def\toclevel@artikel{2}
\newcommand{\l@lid}{\@dottedtocline{1}{3.8em}{2.3em}}
\def\toclevel@lid{3}

% Leden en subleden
\newlist{leden}{enumerate}{2}
\setlist[leden,1]{label=\theartikel.\arabic*.,ref=\arabic*,align=left,itemsep=0pt}
\setlist[leden,2]{label=\abalphnum{\arabic*}),ref=\arabic*,itemsep=0pt}
\counterwithin{ledeni}{artikel}
\counterwithin{ledenii}{ledeni}

% Verwijzingsnaam naar leden en subleden (lid/sub)
\crefname{artikel}{artikel}{artikelen}
\crefname{lid}{lid\unskip}{leden\unskip}
\crefname{ledeni}{lid\unskip}{leden\unskip}
\crefname{ledenii}{onderdeel\unskip}{onderdelen\unskip}

\zref@newprop{artikel}[-1]{\number\value{artikel}}
\zref@newprop{lid}[-1]{\ifnum\value{lid}>0\number\value{lid}\else\number\value{ledeni}\fi}
\zref@newprop{sub}[-1]{\number\value{ledenii}}
\zref@addprops{main}{artikel,lid,sub}

\newcommand{\artnum}[1]{%
\zref@extract{#1}{artikel}%
}

\newcommand{\artformat}[1]{%
\cref@artikel@name~#1%
}

\newcommand{\Artformat}[1]{%
\Cref@artikel@name~#1%
}

\newcommand{\lidnum}[1]{%
\zref@extract{#1}{lid}%
}

\newcommand{\lidformat}[1]{%
\ordinalstringnum{#1}~\cref@ledeni@name%
}

\newcommand{\Lidformat}[1]{%
\Ordinalstringnum{#1}~\cref@ledeni@name%
}

\newcommand{\lidprefix}[2]{%
\ifnum\artnum{#1}=\value{artikel}%
\cref{#2}, van dit artikel%
\else%
\artformat{\artnum{#1}}, \cref{#2}%
\fi%
}

\newcommand{\subnum}[1]{%
\zref@extract{#1}{sub}%
}

\newcommand{\subformat}[1]{%
\cref@ledenii@name~\abalphnum{#1}%
}

\newcommand{\Subformat}[1]{%
\Cref@ledenii@name~\abalphnum{#1}%
}

\newcommand{\subprefix}[2]{%
\ifnum\artnum{#1}=\value{artikel}%
\ifnum\lidnum{#1}=\value{ledeni}%
\cref{#2} van dit lid%
\else%
\lidformat{\lidnum{#1}}, \cref{#2}, van dit artikel%
\fi%
\else%
\artformat{\artnum{#1}}, \lidformat{\lidnum{#1}}, \cref{#2}%
\fi%
}

\newcommand{\Subprefix}[2]{%
\ifnum\artnum{#1}=\value{artikel}%
\ifnum\lidnum{#1}=\value{ledeni}%
\Cref{#2} van dit lid%
\else%
\Lidformat{\lidnum{#1}}, \cref{#2}, van dit artikel%
\fi%
\else%
\Artformat{\artnum{#1}}, \lidformat{\lidnum{#1}}, \cref{#2}%
\fi%
}

\newcommand{\aref}[1]{%
\IfSubStr{#1}{,}{%
\StrBefore[1]{#1}{,}[\firstarg]%
}{%
\def\firstarg{#1}%
}%
\ifthenelse{\equal{\zref@extract{\firstarg}{counter}}{ledeni}}{%
\lidprefix{\firstarg}{#1}%
}{%
\ifthenelse{\equal{\zref@extract{\firstarg}{counter}}{lid}}{%
\lidprefix{\firstarg}{#1}%
}{%
\ifthenelse{\equal{\zref@extract{\firstarg}{counter}}{ledenii}}{%
\subprefix{\firstarg}{#1}%
}{%
\cref{#1}%
}%
}%
}%
}

\newcommand{\Aref}[1]{%
\IfSubStr{#1}{,}{%
\StrBefore[1]{#1}{,}[\Firstarg]%
}{%
\def\Firstarg{#1}%
}%
\ifthenelse{\equal{\zref@extract{\Firstarg}{counter}}{ledeni}}{%
\Lidprefix{\Firstarg}{#1}%
}{%
\ifthenelse{\equal{\zref@extract{\Firstarg}{counter}}{lid}}{%
\Lidprefix{\Firstarg}{#1}%
}{%
\ifthenelse{\equal{\zref@extract{\Firstarg}{counter}}{ledenii}}{%
\Subprefix{\Firstarg}{#1}%
}{%
\Cref{#1}%
}%
}%
}%
}

% Cleveref formats
\crefformat{artikel}{#2\artformat{#1}#3}%
\Crefformat{artikel}{#2\Artformat{#1}#3}%
\crefrangeformat{artikel}{#3\cref@artikel@name@plural~#1#4 \crefrangeconjunction #5#2#6}%
\Crefrangeformat{artikel}{#3\Cref@artikel@name@plural~#1#4 \crefrangeconjunction #5#2#6}%
\crefmultiformat{artikel}{#2\cref@artikel@name@plural~#1#3}{\crefpairconjunction#2#1#3}{\crefmiddleconjunction#2#1#3}{\creflastconjunction#2#1#3}%
\Crefmultiformat{artikel}{#2\Cref@artikel@name@plural~#1#3}{\crefpairconjunction#2#1#3}{\crefmiddleconjunction#2#1#3}{\creflastconjunction#2#1#3}%

\crefformat{ledeni}{#2\lidformat{#1}#3}%
\Crefformat{ledeni}{#2\Lidformat{#1}#3}%
\crefrangeformat{ledeni}{#3\ordinalstringnum{#1}#4 \crefrangeconjunction #5\lidformat{#2}#6}%
\Crefrangeformat{ledeni}{#3\Ordinalstringnum{#1}#4 \crefrangeconjunction #5\lidformat{#2}#6}%
\crefmultiformat{ledeni}{#2\ordinalstringnum{#1}#3}{\crefpairconjunction #2\lidformat{#1}#3}{\crefmiddleconjunction#2\ordinalstringnum{#1}#3}{\creflastconjunction#2\lidformat{#1}#3}%
\Crefmultiformat{ledeni}{#2\Ordinalstringnum{#1}#3}{\crefpairconjunction #2\lidformat{#1}#3}{\crefmiddleconjunction#2\ordinalstringnum{#1}#3}{\creflastconjunction#2\lidformat{#1}#3}%

\crefformat{lid}{#2\lidformat{#1}#3}%
\Crefformat{lid}{#2\Lidformat{#1}#3}%
\crefrangeformat{lid}{#3\ordinalstringnum{#1}#4 \crefrangeconjunction #5\lidformat{#2}#6}%
\Crefrangeformat{lid}{#3\Ordinalstringnum{#1}#4 \crefrangeconjunction #5\lidformat{#2}#6}%
\crefmultiformat{lid}{#2\ordinalstringnum{#1}#3}{\crefpairconjunction #2\lidformat{#1}#3}{\crefmiddleconjunction#2\ordinalstringnum{#1}#3}{\creflastconjunction#2\lidformat{#1}#3}%
\Crefmultiformat{lid}{#2\Ordinalstringnum{#1}#3}{\crefpairconjunction #2\lidformat{#1}#3}{\crefmiddleconjunction#2\ordinalstringnum{#1}#3}{\creflastconjunction#2\lidformat{#1}#3}%

\crefformat{ledenii}{#2\subformat{#1}#3}%
\Crefformat{ledenii}{#2\Subformat{#1}#3}%
\crefrangeformat{ledenii}{#3\cref@ledenii@name@plural~\abalphnum{#1}#4 \crefrangeconjunction #5\abalphnum{#2}#6}%
\Crefrangeformat{ledenii}{#3\Cref@ledenii@name@plural~\abalphnum{#1}#4 \crefrangeconjunction #5\abalphnum{#2}#6}%
\crefmultiformat{ledenii}{#2\cref@ledenii@name@plural~\abalphnum{#1}#3}{\crefpairconjunction#2\abalphnum{#1}#3}{\crefmiddleconjunction#2\abalphnum{#1}#3}{\creflastconjunction#2\abalphnum{#1}#3}%
\Crefmultiformat{ledenii}{#2\Cref@ledenii@name@plural~\abalphnum{#1}#3}{\crefpairconjunction#2\abalphnum{#1}#3}{\crefmiddleconjunction#2\abalphnum{#1}#3}{\creflastconjunction#2\abalphnum{#1}#3}%

\GetAllResetLists
\RegisterPostLabelHook{\zlabel}

\newcommand\newentity[2]{
    \pgfkeys{
        /entity/#1/.is family,
        /entity/#1,
        name/.initial=<naam>,
        title/.initial=<functie titel>,
        gender/.initial=<male|female>,
        company/.initial=<bedrijf>,
        kvk/.initial=<kvk nummer>,
        website/.initial=<website>,
        email/.initial=<e-mail>,
        address/.initial=<adres>,
        postal/.initial=<postcode>,
        place/.initial=<plaats>,
        iban/.initial=<iban>,
        sign date/.initial=<datum>,
        sign place/.initial=<plaats>
    }
    \pgfkeys{/entity/#1,#2}
}
\newcommand\entityval[2]{\pgfkeysvalueof{/entity/#1/#2}\xspace}
\newcommand\nameOf[1]{\entityval{#1}{name}}
\newcommand\titleOf[1]{\entityval{#1}{title}}
\newcommand\companyOf[1]{\entityval{#1}{company}}
\newcommand\kvkOf[1]{\entityval{#1}{kvk}}
\newcommand\websiteOf[1]{\entityval{#1}{website}}
\newcommand\emailOf[1]{\entityval{#1}{email}}
\newcommand\addressOf[1]{\entityval{#1}{address}}
\newcommand\postalOf[1]{\entityval{#1}{postal}}
\newcommand\placeOf[1]{\entityval{#1}{place}}
\newcommand\ibanOf[1]{\entityval{#1}{iban}}
\newcommand\signdateOf[1]{\entityval{#1}{sign date}}
\newcommand\signplaceOf[1]{\entityval{#1}{sign place}}

\newcommand\salute[1]{%
    \ifthenelse{\equal{\pgfkeysvalueof{/entity/#1/gender}}{female}}{mevrouw }{de heer }%
    \nameOf{#1}%
}
\WithSuffix\newcommand\salute*[1]{%
    \ifthenelse{\equal{\pgfkeysvalueof{/entity/#1/gender}}{female}}{mevr.\ }{dhr.\ }%
    \nameOf{#1}%
}

\newcommand\Salute[1]{%
    \ifthenelse{\equal{\pgfkeysvalueof{/entity/#1/gender}}{female}}{Mevrouw }{De heer }%
    \nameOf{#1}%
}

\WithSuffix\newcommand\Salute*[1]{%
    \ifthenelse{\equal{\pgfkeysvalueof{/entity/#1/gender}}{female}}{Mevr.\ }{Dhr.\ }%
    \nameOf{#1}%
}

\newcommand\signature[1]{
    \@ifpackageloaded{tabularx}{%
    \noindent\textbf{\companyOf{#1}} \\
    \vspace{3cm}\\
    {\tiny Handtekening:}\\[-1em]
    \rule{\linewidth}{.1pt}
    \\[1em]
    \begin{tabularx}{\linewidth}{@{}p{\widthof{Functie:\quad}}@{}X@{}}
        Naam:    & \nameOf{#1}      \\
        Functie: & \titleOf{#1}     \\
        Datum:   & \signdateOf{#1}  \\
        Plaats:  & \signplaceOf{#1} \\
    \end{tabularx}
    }{\PackageError{regulatory}{Missing tabularx}{The package tabularx needs to be loaded}}
}

\newcommand\contact[1]{%
%    \artikel{Contactgegevens \companyOf{#1}, \nameOf{#1}}\label{art:contact}
    \@ifpackageloaded{tabularx}{%
    \begin{tabularx}{\linewidth}{@{}l l X l l@{}}
        Bedrijfsnaam:       & \companyOf{#1}               & & KvK-nummer: & \kvkOf{#1}     \\
        Adres:              & \addressOf{#1}               & & E-mail:     & \emailOf{#1}   \\
        Postcode en plaats: & \postalOf{#1}, \placeOf{#1} & & Website:    & \websiteOf{#1} \\
    \end{tabularx}
    }{\PackageError{regulatory}{Missing tabularx}{The package tabularx needs to be loaded}}
}

\newcommand*\contractor{contractor}
\newcommand\client{client}

\newcommand\myname{\nameOf{\contractor}}
\newcommand\mytitle{\titleOf{\contractor}}
\newcommand\mycompany{\companyOf{\contractor}}
\newcommand\mykvk{\kvkOf{\contractor}}
\newcommand\mywebsite{\websiteOf{\contractor}}
\newcommand\myemail{\pgfkeysvalueof{/entity/\contractor/email}}
\newcommand\myaddress{\pgfkeysvalueof{/entity/\contractor/address}}
\newcommand\mypostal{\pgfkeysvalueof{/entity/\contractor/postal}}
\newcommand\myplace{\pgfkeysvalueof{/entity/\contractor/place}}
\newcommand\myiban{\pgfkeysvalueof{/entity/\contractor/iban}}
\newcommand\mysigndate{\pgfkeysvalueof{/entity/\contractor/sign date}}
\newcommand\mysignplace{\pgfkeysvalueof{/entity/\contractor/sign place}}

%\newcommand\contractor{contractor}
\newcommand\setcontractor[1]{\renewcommand\contractor{#1}}
%\newcommand\client{client}
\newcommand\setclient[1]{\renewcommand\client{#1}}

\IfFileExists{entities.tex}{%
    \input{entities.tex}
}{\PackageWarning{regulatory}{No entities.tex found}}

% Schakelbepalingen
%\RequirePackage{attachfile}
\makeatletter
\newcommand*{\addFileDependency}[1]{% argument=file name and extension
\typeout{(#1)}
\@addtofilelist{#1}
\IfFileExists{#1}{}{\typeout{No file #1.}}
}
% https://www.overleaf.com/learn/how-to/Cross_referencing_with_the_xr_package_in_Overleaf
\makeatother
\newcommand{\extdoc}[2][ext-]{%
\externaldocument[#1]{../../#2/out/main}%
\addFileDependency{../../#2/src/main.tex}%
\addFileDependency{../../#2/out/main.aux}%
}

\makeatletter

\newglossary*{definitions}{Definitions}
\newglossary*{externals}{Externals}
\newignoredglossary{externals}
% Macro's
\newcommand\describe[1]{\glstarget{#1}{\glsentrydesc{#1}.}}
%\newcommand\describe[1]{\setboolean{regulatory@defslisted}{true}\glstarget{#1}{\glsentrydesc{#1}.}}
\newcommand\printdefs[1]{%
    \setboolean{regulatory@defslisted}{true}%
    \glssetwidest{#1\quad}%
    \ifthenelse{\boolean{regulatory@usebib2gls}}{\printunsrtglossary[type=definitions]}{\printglossary[type=definitions]}}

\newcommand\@regulatory@extradefs{}
\newcommand\extradefs[1]{\renewcommand\@regulatory@extradefs{,#1}}

\newcommand\loadglsdefs[1]{%
    \setboolean{regulatory@defslisted}{true}%
    \ifthenelse{\boolean{regulatory@usebib2gls}}{%
        \GlsXtrLoadResources[type=definitions,src={#1},sort={nl-NL},category={defs}\@regulatory@bib@selection]%
    }{%
        \loadglsentries[definitions]{#1}%
    }%
}

%\glssetcategoryattribute{external}{targeturl}{algemene_voorwaarden.pdf}
%\glssetcategoryattribute{external}{targetname}{\glolinkprefix\glslabel}
%\glssetcategoryattribute{external}{refered}{false}
%\newignoredglossary*{external}
%\glsdefpostlink{external}{%
%    \glsxtrifwasfirstuse{% true case
%        \ifthenelse{\equal{\glsgetcategoryattribute{defs}{refered}}{false}}{%
%        \glssetcategoryattribute{defs}{refered}{true}%
%        \glsifcategory{\glslabel}{defs}{%
%%        \glsxtrifhasfield{useri}{\glslabel}{\space%
%        % \glscurrentfieldvalue needs to be expanded
%        % before being passed to \cite.
%            ~(zie Algemene Voorwaarden\footnote{\href{\glsgetcategoryattribute{defs}{targeturl}}{Algemene Voorwaarden}})}%
%        }{}% false refered
%%        {}% false glsxtrifhasfield
%    }% end true glsxtrifwasfirstuse
%    {}%{<false>} glsxtrifwasfirstuse
%} % end glsdefpostlink

%\newignoredglossary{ignored}
%\GlsXtrLoadResources[
%src=example-glossaries-acronym,
%trigger-type=ignored,
%category=abbreviation
%]

\ifthenelse{\boolean{regulatory@usebib2gls}}{%
    \RequirePackage[record,style=alttree]{glossaries-extra}
    \setboolean{regulatory@defslisted}{true}
    \AtEndPreamble{\loadglsdefs{defs\@regulatory@extradefs}}
}{%
    \IfFileExists{defs.tex}{%
        \AtEndPreamble{
        \setboolean{regulatory@defslisted}{true}%
        \loadglsentries{defs.tex}\makeglossaries}}{%
        \PackageWarning{regulatory}{No defs.tex found}}%
}
\ifthenelse{\boolean{regulatory@defslisted}}{}{\glsdisablehyper}
\AtEndDocument{\ifthenelse{\boolean{regulatory@alldefs}}{\glsaddallunused}{}}

\makeatother
