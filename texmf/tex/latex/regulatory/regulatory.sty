\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{regulatory}[2022/06/19 Xerdi's Regulatory Package]

\RequirePackage{xifthen}
\RequirePackage{keyval}
\RequirePackage{xstring}
\RequirePackage{xspace}

\newboolean{regulatory@usemarkdown}
\setboolean{regulatory@usemarkdown}{false}
\DeclareOption{markdown}{%
    \setboolean{regulatory@usemarkdown}{true}%
}

\newboolean{regulatory@usebib2gls}
\setboolean{regulatory@usebib2gls}{true}
\DeclareOption{bibdefs}{\setboolean{regulatory@usebib2gls}{true}}
\DeclareOption{nobibdefs}{\setboolean{regulatory@usebib2gls}{false}}

\DeclareOption{hidelinks}{%
    \PassOptionsToPackage{hidelinks}{hyperref}}

\newboolean{regulatory@alldefs}
\setboolean{regulatory@alldefs}{false}
\DeclareOption{alldefs}{\setboolean{regulatory@alldefs}{true}}


\newcommand\middleconjunction{, }
\newcommand\lastconjunction{ en }
\newcommand\rangeconjunction{ t/m }

\newcommand\setmiddleconjunction[1]{\renewcommand\middleconjunction{#1}}
\newcommand\setlastconjunction[1]{\renewcommand\lastconjunction{#1}}
\newcommand\setrangeconjunction[1]{\renewcommand\rangeconjunction{#1}}

\newcommand\setconjunction[3]{%
    \setmiddleconjunction{#1}%
    \setlastconjunction{#1}%
    \setrangeconjunction{#1}%
}

\newcommand\setjuncto{%
\setlastconjunction{ jo.\ }%
}

\newcommand\unsetjuncto{%
\setlastconjunction{ en~}%
}

\DeclareOption{juncto}{%
    \setjuncto}

\DeclareOption*{\PackageError{regulatory}{Unknown option}{Options are markdown,bibdefs,nobibdefs,alldefs,hidelinks}}
\ProcessOptions*

% Markdown support
\ifthenelse{\boolean{regulatory@usemarkdown}}{
\RequirePackage[hashEnumerators,definitionLists,hybrid,headerAttributes=true]{markdown}
\newcommand{\uitlijning}[1]{\glssetwidest{#1}}%
\setkeys{markdownRenderers}{
headingOne={\artikel{#1}},
olItemWithNumber={\item{}},
olBeginTight={\begin{leden}},
olEndTight={\end{leden}},
olBegin={\begin{leden}},
olEnd={\end{leden}},
dlBeginTight={\begin{labeling}{\@glswidestname}},
dlEndTight={\end{labeling}},
dlBegin={\begin{labeling}{\@glswidestname}},
dlEnd={\end{labeling}}%
\renewcommand\markdownRendererOlItemWithNumber[1]{\item{}\label{ml:##1}}
}
}{}

% Pakketten nÃ¡ markdown (anders gaat enumitem kapot)
\RequirePackage{xcolor}
\RequirePackage{xassoccnt}
\RequirePackage{xpatch}
\RequirePackage{titlesec} % voor artikelen
\RequirePackage{enumitem} % voor leden/subleden
\RequirePackage{fmtcount} % voor tekstuele leden
\RequirePackage{scrextend} % voor definitie lijsten
\RequirePackage{xr-hyper} %
\RequirePackage{hyperref} % voor linkjes
\RequirePackage[user,counter,hyperref,xr]{zref} % voor verwijzingen
\RequirePackage{zref-xr,zref-user,zref-clever,zref-hyperref}
\RequirePackage{pgf} % voor entities
\RequirePackage{suffix} % voor macro's met asterisk
\RequirePackage[sanitize=none,nonumberlist,nopostdot]{glossaries} % voor definitie lijsten
\ifthenelse{\boolean{regulatory@usebib2gls}}{%
    \RequirePackage[record,style=alttree]{glossaries-extra}
}{%
    \PackageWarning{regulatory}{Using glossaries for definitions without bib2gls. This is mostly untested.}
}
\RequirePackage{attachfile2}

\newboolean{regulatory@defslisted}
\setboolean{regulatory@defslisted}{false}
% Glossary overrides
\setglossarystyle{alttree}
\renewcommand{\glossarysection}[2][]{}
\renewcommand*{\glsnamefont}[1]{\textmd{\textit{#1}}}
\renewcommand*{\glstextformat}{\textit}

% Kleuren
\colorlet{artlabel}{black}
\colorlet{arttitle}{black}
\colorlet{lidlabel}{black}
\colorlet{lidtitle}{black}
\colorlet{sublabel}{black}
\colorlet{subtitle}{black}


% Artikelen
\newcounter{artikel}
\titleclass{\artikel}{straight}[\part]
\titleformat{\artikel}{\normalfont\color{arttitle}}{\bfseries\color{artlabel}Artikel \theartikel.\quad}{1em}{}
\titlespacing*{\artikel}{0pt}{3.5ex plus 1ex minus .2ex}{5pt}

\newcounter{lid}
\titleclass{\lid}{straight}[\part]
\titleformat{\lid}{\normalfont\color{lidtitle}}{\normalfont\color{lidlabel}\theartikel.\thelid.\quad}{1em}{}
\titlespacing*{\lid}{0pt}{3.5ex plus 1ex minus .2ex}{5pt}
\counterwithin{lid}{artikel}

\renewcommand{\theartikel}{\arabic{artikel}}
\renewcommand{\thelid}{\arabic{lid}}
\makeatletter
\newcommand{\l@artikel}{\@dottedtocline{1}{1.5em}{2.3em}}
\def\toclevel@artikel{2}
\newcommand{\l@lid}{\@dottedtocline{1}{3.8em}{2.3em}}
\def\toclevel@lid{3}

% Leden en subleden
\newlist{leden}{enumerate}{2}
\setlist[leden,1]{label=\theartikel.\arabic*.,ref=\arabic*,align=left,itemsep=0pt}
\setlist[leden,2]{label=\abalphnum{\arabic*}),ref=\arabic*,itemsep=0pt}
\counterwithin{ledeni}{artikel}
\counterwithin{ledenii}{ledeni}

\zref@newprop{artikel}[-1]{\number\value{artikel}}
\zref@newprop{lid}[-1]{\ifnum\value{lid}>0\number\value{lid}\else\number\value{ledeni}\fi}
\zref@newprop{sub}[-1]{\number\value{ledenii}}
\zref@addprops{main}{artikel,lid,sub}

\zcRefTypeSetup{artikel}{%
    Name-sg = Artikel,
    name-sg = artikel,
    Name-pl = Artikelen,
    name-pl = artikelen
}
\zcRefTypeSetup{lid}{%
    Name-sg = Lid,
    name-sg = lid,
    Name-pl = Leden,
    name-pl = leden
}
\zcRefTypeSetup{ledeni}{%
    Name-sg = Lid,
    name-sg = lid,
    Name-pl = Leden,
    name-pl = leden
}
\zcRefTypeSetup{ledenii}{%
    Name-sg = Onderdeel,
    name-sg = onderdeel,
    Name-pl = Onderdelen,
    name-pl = onderdelen
}

\makeatother
{\catcode`\#=12 \gdef\hashchar{#}}
\makeatletter
\newcommand\@aref@hl[1]{\edef\next{%
    \noexpand\href{\@aref@fullurl}{#1}}\next}

% Artikel labels
\def\@aref@artikel@prefix{artikel~}
\def\@Aref@artikel@prefix{Artikel~}
\def\@aref@artikel@postfix{}
\def\@aref@artikel@format{\@aref@artikel}
\def\@aref@artikel@formathl{\@aref@hl{\@aref@artikel@format}}
\def\@aref@artikel@nformat{\@aref@artikel@prefix\@aref@artikel}
\def\@Aref@artikel@nformat{\@Aref@artikel@prefix\@aref@artikel}
\def\@aref@artikel@nformathl{\@aref@artikel@prefix\@aref@artikel@formathl}
\def\@Aref@artikel@nformathl{\@Aref@artikel@prefix\@aref@artikel@formathl}


% Lid labels
\def\@aref@lid@prefix{}
\def\@Aref@lid@prefix{}
\def\@aref@lid@postfix{~lid}
\def\@aref@lid@format{\ordinalstringnum{\@aref@lid}}
\def\@Aref@lid@format{\Ordinalstringnum{\@aref@lid}}
\def\@aref@lid@formathl{\@aref@hl{\@aref@lid@format}}
\def\@Aref@lid@formathl{\@aref@hl{\@Aref@lid@format}}
\def\@aref@lid@nformat{\@aref@lid@format\@aref@lid@postfix}
\def\@aref@lid@nformathl{\@aref@lid@formathl\@aref@lid@postfix}
\def\@Aref@lid@nformat{\@Aref@lid@format\@aref@lid@postfix}
\def\@Aref@lid@nformathl{\@Aref@lid@formathl\@aref@lid@postfix}

% Sub labels
\def\@aref@sub@prefix{onderdeel~}
\def\@Aref@sub@prefix{Onderdeel~}
\def\@aref@sub@postfix{}
\def\@aref@sub@format{\abalphnum{\@aref@sub}}
\def\@aref@sub@formathl{\@aref@hl{\@aref@sub@format}}
\def\@aref@sub@nformat{\@aref@sub@prefix\@aref@sub@format}
\def\@aref@sub@nformathl{\@aref@sub@prefix\@aref@sub@formathl}
\def\@Aref@sub@nformat{\@Aref@sub@prefix\@aref@sub@format}
\def\@Aref@sub@nformathl{\@Aref@sub@prefix\@aref@sub@formathl}

\def\@ifartifactisset#1#2#3{%
    \pgfkeysifdefined{/artifact/#1/.is family}{#2}{#3}%
}

\newcommand\@aref@setvars[1]{%
    \def\@aref@count{\zref@extract{#1}{counter}}%
    \def\@aref@artikel{\zref@extract{#1}{artikel}}%
    \def\@aref@lid{\zref@extract{#1}{lid}}%
    \def\@aref@sub{\zref@extract{#1}{sub}}%
    \def\@aref@anchor{\zref@extract{#1}{anchor}}%
    \def\@aref@url{\zref@extractdefault{#1}{url}{}}%
    \def\@aref@fullurl{\@aref@url\hashchar\@aref@anchor}%
    \zref@ifrefcontainsprop{#1}{externaldocument}{%
        \def\@aref@filelabel{\zref@extract{#1}{externaldocument}}%
        \def\@aref@postlink{%
            \ifthenelse{\equal{\artifactfootnote{\@aref@filelabel}}{true}\and\equal{\artifactreferred{\@aref@filelabel}}{false}}{%
                \reffootnotelabel{\@aref@filelabel}%
            }{}%
        }%
    }{%
        \def\@aref@postlink{}%
    }%
    \ifthenelse{\equal{\@aref@count}{artikel}}{%
        \def\@aref@type{artikel}%
        \def\@aref@format{\@aref@artikel@formathl}%
        \def\@aref@formatn{\@ifacap{\@Aref@artikel@prefix}{\@aref@artikel@prefix}\@aref@format}%
        \def\@aref@prefix{\@ifacap{\@Aref@artikel@prefix}{\@aref@artikel@prefix}}%
        \def\@aref@postfix{}%
    }{%
        \ifthenelse{\equal{\@aref@count}{ledeni}\OR\equal{\@aref@count}{lid}}{%
            \def\@aref@type{lid}%
            \def\@aref@format{\@ifacap{\@Aref@lid@formathl}{\@aref@lid@formathl}}%
            \def\@aref@formatn{\@aref@format\@aref@lid@postfix}%
            \def\@aref@prefix{%
                \@ifacap{\@Aref@artikel@prefix}{\@aref@artikel@prefix}\@aref@artikel@format,~%
            }%
            \def\@aref@postfix{\@aref@lid@postfix}%
        }{%
            \ifthenelse{\equal{\@aref@count}{ledenii}}{%
                \def\@aref@type{sub}%
                \def\@aref@format{\@aref@sub@formathl}%
                \def\@aref@prefix{%
                    \@ifacap{\@Aref@artikel@prefix}{\@aref@artikel@prefix}\@aref@artikel@format,~%
                    \@ifacap{\@Aref@lid@format}{\@aref@lid@format}\@aref@lid@postfix,~%
                    \@ifacap{\@Aref@sub@prefix}{\@aref@sub@prefix}%
                }%
                \def\@aref@postfix{}%
            }{%
                \def\@aref@type{page}%
                \def\@aref@format{??}%
                \def\@aref@prefix{}%
                \def\@aref@postfix{}%
            }%
        }%
    }%
    \def\@aref@number##1{\zref@extractdefault{##1}{\@aref@type}{-1}}%
}

\newboolean{aref@cap}
\def\@ifacap#1#2{\ifthenelse{\boolean{aref@cap}}{#1\setboolean{aref@cap}{false}}{#2}}

% https://tex.stackexchange.com/questions/164118/special-case-for-last-element-with-foreach
\newcommand{\aref}[1]{%
    \IfSubStr{#1}{,}{%
        \StrBefore[1]{#1}{,}[\firstarg]%
    }{%
        \def\firstarg{#1}%
    }%
    \@aref@setvars{\firstarg}%
    \@aref@prefix\aref@group{#1}\@aref@postfix\@aref@postlink%
}

\newcommand{\Aref}[1]{%
    \setboolean{aref@cap}{true}%
    \IfSubStr{#1}{,}{%
        \StrBefore[1]{#1}{,}[\Firstarg]%
    }{%
        \def\Firstarg{#1}%
    }%
    \@aref@setvars{\Firstarg}%
    \@aref@prefix\aref@group{#1}\@aref@postfix\@aref@postlink%
}

\def\listterminator{-1}

\newcommand\aref@group[1]{%
    \bubblesort{#1}%
    \expandafter\begincompaction\sortedlist,\listterminator,\relax%
}
\def\begincompaction#1,#2\relax{%
    \def\startlist{#1}%
    \def\currentendlist{#1}%
    \findendlist#2\relax%
}
\def\findendlist#1,#2\relax{%
    \@aref@setvars{#1}%
    \ifnum\numexpr\@aref@number{\currentendlist}+1\relax=\@aref@number{#1}\relax%
        \def\currentendlist{#1}%
        \findendlist#2\relax%
    \else%
        \@aref@setvars{\startlist}%
        \ifnum\@aref@number{\startlist}=\@aref@number{\currentendlist}\relax%
            \ignorespaces\@aref@format\unskip%
        \else%
            \ifnum\numexpr\@aref@number{\startlist}+1\relax=\@aref@number{\currentendlist}\relax%
                \ignorespaces\@aref@format\unskip%
                \ifnum\@aref@number{#1}=\listterminator\relax%
                    \lastconjunction%
                \else%
                    \middleconjunction%
                \fi\ignorespaces\@aref@setvars{\currentendlist}\@aref@format\unskip%
            \else%
                \ignorespaces\@aref@format\unskip\rangeconjunction\ignorespaces\@aref@setvars{\currentendlist}\@aref@format\unskip%
            \fi%
        \fi%
        \ifnum\@aref@number{#1}=\listterminator%
        \else%
            \IfStrEq{#2}{\listterminator,}{\lastconjunction}{\middleconjunction}\begincompaction#1,#2\relax%
        \fi%
    \fi%
}
\newcommand\bubblesort[1]{\def\sortedlist{}\sortlist#1,\listterminator,\relax}
\def\sortlist#1,#2,#3\relax{%
    \@aref@setvars{#1}%
    \ifnum\@aref@number{#2}=\listterminator\relax%
        \edef\sortedlist{\sortedlist#1}%
    \else%
        \ifnum\@aref@number{#1}<\@aref@number{#2}\relax%
            \edef\sortedlist{\sortedlist#1,}%
            \sortlist#2,#3\relax%
        \else%
            \let\tmp\sortedlist%
            \def\sortedlist{}%
            \expandafter\sortlist\tmp#2,#1,#3\relax%
        \fi%
    \fi%
}

\GetAllResetLists
\RegisterPostLabelHook{\zlabel}

\newglossary*{definitions}{Definitions}
\newglossary*{externals}{Externals}


\newcommand\newartifact[2]{%
    \pgfkeys{
        /artifact/#1/.is family,
        /artifact/#1,
        name/.initial = #1,
        filename/.initial = #1.pdf,
        footnote/.initial = true,
        url/.initial=,
        referred/.initial = false,
        defs/.initial=,
        author/.initial=<author>,
        subject/.initial=<subject>,
        description/.initial=<description>
    }
    \pgfkeys{/artifact/#1,#2}
}
\newcommand\@aget[2]{\pgfkeysvalueof{/artifact/#1/#2}}
\newcommand\artifactname[1]{\@aget{#1}{name}}
\newcommand\artifactfilename[1]{\@aget{#1}{filename}}
\newcommand\artifactfootnote[1]{\@aget{#1}{footnote}}
\newcommand\artifacturl[1]{\@aget{#1}{url}}
\newcommand\artifactreferred[1]{\@aget{#1}{referred}}
\newcommand\artifactdefs[1]{\@aget{#1}{defs}}
\newcommand\artifactauthor[1]{\@aget{#1}{author}}
\newcommand\artifactsubject[1]{\@aget{#1}{subject}}
\newcommand\artifactdescription[1]{\@aget{#1}{description}}

\newcommand\describe[1]{\setboolean{regulatory@defslisted}{true}\glstarget{#1}{\glsentrydesc{#1}}}
\newcommand\printdefs[1]{%
    \setboolean{regulatory@defslisted}{true}%
    \glssetwidest{#1\quad}%
    \ifthenelse{\boolean{regulatory@usebib2gls}}{\printunsrtglossary[type=definitions]}{\printglossary[type=definitions]}}

\attachfilesetup{color=black}

\newcommand\reffootnotelabel[1]{%
\pgfkeys{/artifact/#1,referred=true}%
\def\@tmpfile{\artifactfilename{#1}}%
, van \artifactsubject{#1}\footnote{Bijlage: \textattachfile[description={\artifactdescription{#1}},subject={\artifactsubject{#1}},author={\artifactauthor{#1}}]{\@tmpfile}{\@tmpfile}}%
}

\newcommand\deffootnotelabel[1]{%
    \pgfkeys{/artifact/#1,referred=true}%
    \def\@tmpfile{\artifactfilename{#1}}%
    ~(zie \artifactsubject{#1}\footnote{Bijlage: \textattachfile[description={\artifactdescription{#1}},subject={\artifactsubject{#1}},author={\artifactauthor{#1}}]{\@tmpfile}{\@tmpfile}})%
}

\edef\@regulatory@bib@selection{}
\ifthenelse{\boolean{regulatory@alldefs}}{\edef\@regulatory@bib@selection{,selection=all}}{}
%\newcommand\@regulatory@extradefs{}
%\newcommand\extradefs[1]{\renewcommand\@regulatory@extradefs{,#1}}

\newcommand\loadglsdefs[1]{%
    \setboolean{regulatory@defslisted}{true}%
    \ifthenelse{\boolean{regulatory@usebib2gls}}{%
        \GlsXtrLoadResources[type=definitions,src={#1},sort={nl-NL},category={defs}\@regulatory@bib@selection]%
    }{%
        \loadglsentries[definitions]{#1}%
    }%
}

\newcommand\loadextdefs[2][externals]{%
    \ifthenelse{\boolean{regulatory@usebib2gls}}{%
        \GlsXtrLoadResources[type=externals,src={#2},sort={nl-NL},category={#1}]%
    }{%
        \loadglsentries[externals]{#2}%
    }%
    \glsdefpostlink{#1}{%
        \ifthenelse{\equal{\artifactreferred{#1}}{true}}{}{%
            \deffootnotelabel{#1}%
        }%
    }%
}

\newcommand\refdocument[2][ext-]{%
    \newartifact{#2}{footnote=false}%
    \zexternaldocument[#1]{#2}%
}

\newcommand\masterdocument[3][ext-]{%
    \newartifact{#2}{#3}%
    \zexternaldocument[#1]{#2}%
    \ifthenelse{\equal{\string\artifactdefs{#2}}{}}{%
        \PackageWarning{regulatory}{No definitions given to the master document. \the\gls commands will therefore not work.}%
    }{%
        \loadextdefs[#2]{\artifactdefs{#2}}%
        \ifthenelse{\boolean{regulatory@usebib2gls}}{%
            \glssetcategoryattribute{#2}{targeturl}{\artifactfilename{#2}}%
            \glssetcategoryattribute{#2}{targetname}{\glolinkprefix\glslabel}%
        }{}%
    }%
}

\AtEndPreamble{\ifthenelse{\boolean{regulatory@usebib2gls}}{}{\ifthenelse{\boolean{regulatory@defslisted}}{\makeglossaries}{}}}
\AtEndDocument{\ifthenelse{\boolean{regulatory@alldefs}}{\glsaddallunused}{}}

\makeatother
