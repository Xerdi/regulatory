\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{regulatory}[2022/06/19 Xerdi's Regulatory Package]

\RequirePackage{xifthen}
\RequirePackage{keyval}
\RequirePackage{xstring}
\RequirePackage{xspace}

\newboolean{regulatory@usemarkdown}
\setboolean{regulatory@usemarkdown}{false}
\DeclareOption{markdown}{%
    \setboolean{regulatory@usemarkdown}{true}%
}

\newboolean{regulatory@usebib2gls}
\setboolean{regulatory@usebib2gls}{true}
\DeclareOption{bibdefs}{\setboolean{regulatory@usebib2gls}{true}}
\DeclareOption{nobibdefs}{\setboolean{regulatory@usebib2gls}{false}}

\DeclareOption{hidelinks}{%
    \PassOptionsToPackage{hidelinks}{hyperref}}

\newboolean{regulatory@alldefs}
\setboolean{regulatory@alldefs}{false}
\DeclareOption{alldefs}{\setboolean{regulatory@alldefs}{true}}


\newcommand\middleconjunction{, }
\newcommand\lastconjunction{ en }
\newcommand\rangeconjunction{ t/m }

\newcommand\setmiddleconjunction[1]{\renewcommand\middleconjunction{#1}}
\newcommand\setlastconjunction[1]{\renewcommand\lastconjunction{#1}}
\newcommand\setrangeconjunction[1]{\renewcommand\rangeconjunction{#1}}

\newcommand\setconjunction[3]{%
    \setmiddleconjunction{#1}%
    \setlastconjunction{#1}%
    \setrangeconjunction{#1}%
}

\newcommand\setjuncto{%
\setlastconjunction{ jo.\ }%
}

\newcommand\unsetjuncto{%
\setlastconjunction{ en~}%
}

\DeclareOption{juncto}{%
    \setjuncto}

\DeclareOption*{\PackageError{regulatory}{Unknown option}{Options are markdown,bibdefs,nobibdefs,alldefs,hidelinks}}
\ProcessOptions*

% Markdown support
\ifthenelse{\boolean{regulatory@usemarkdown}}{
\RequirePackage[hashEnumerators,definitionLists,hybrid,headerAttributes=true]{markdown}
\setkeys{markdownRenderers}{
headingOne={\article{#1}},
olItemWithNumber={\item{}},
olBeginTight={\begin{paras}},
olEndTight={\end{paras}},
olBegin={\begin{paras}},
olEnd={\end{paras}},
dlBeginTight={\begin{labeling}{\@glswidestname}},
dlEndTight={\end{labeling}},
dlBegin={\begin{labeling}{\@glswidestname}},
dlEnd={\end{labeling}}%
\renewcommand\markdownRendererOlItemWithNumber[1]{\item{}\label{ml:##1}}
}
}{}

% Pakketten nÃ¡ markdown (anders gaat enumitem kapot)
\RequirePackage{xcolor}
\RequirePackage{xassoccnt}
\RequirePackage{xpatch}
\RequirePackage[loadonly]{titlesec}
\RequirePackage{enumitem}
\RequirePackage{fmtcount}
\RequirePackage{scrextend}
\RequirePackage{xr-hyper}
\RequirePackage{hyperref}
\RequirePackage[user,counter,hyperref,xr]{zref}
\RequirePackage{zref-xr,zref-user,zref-clever,zref-hyperref}
\RequirePackage{pgf}
%\RequirePackage{suffix}
\RequirePackage[sanitize=none,nopostdot]{glossaries}
\ifthenelse{\boolean{regulatory@usebib2gls}}{%
    \RequirePackage[record,style=alttree]{glossaries-extra}
}{%
    \PackageWarning{regulatory}{Using glossaries for definitions without bib2gls. This is mostly untested.}
}
\RequirePackage{attachfile2}

\newboolean{regulatory@defslisted}
\setboolean{regulatory@defslisted}{false}

% Kleuren
\colorlet{artlabel}{black}
\colorlet{arttitle}{black}
\colorlet{paralabel}{black}
\colorlet{paratitle}{black}
\colorlet{sublabel}{black}
\colorlet{subtitle}{black}


% Artikelen
\newcounter{article}
\titleclass{\article}[0]{straight}
\titleformat{\article}{\normalfont\color{arttitle}}{\bfseries\color{artlabel}Artikel \thearticle.\quad}{1em}{}
\titlespacing*{\article}{0pt}{3.5ex plus 1ex minus .2ex}{5pt}

\newcounter{para}
\titleclass{\para}{straight}[\article]
\titleformat{\para}{\normalfont\color{paratitle}}{\normalfont\color{paralabel}\thearticle.\thepara.\quad}{1em}{}
\titlespacing*{\para}{0pt}{3.5ex plus 1ex minus .2ex}{5pt}
\counterwithin{para}{article}

\renewcommand{\thearticle}{\arabic{article}}
\renewcommand{\thepara}{\arabic{para}}
\makeatletter
\newcommand{\l@article}{\@dottedtocline{1}{1.5em}{2.3em}}
\def\toclevel@article{2}
\newcommand{\l@para}{\@dottedtocline{1}{3.8em}{2.3em}}
\def\toclevel@para{3}

\newlist{paras}{enumerate}{2}
\setlist[paras,1]{label=\thearticle.\arabic*.,ref=\arabic*,align=left,itemsep=0pt}
\setlist[paras,2]{label=\abalphnum{\arabic*}),ref=\arabic*,itemsep=0pt}
\counterwithin{parasi}{article}
\counterwithin{parasii}{parasi}

\zref@newprop{article}[-1]{\number\value{article}}
\zref@newprop{para}[-1]{\ifnum\value{para}>0\number\value{para}\else\number\value{parasi}\fi}
\zref@newprop{sub}[-1]{\number\value{parasii}}
\zref@addprops{main}{article,para,sub}

\zcRefTypeSetup{article}{%
    Name-sg = Artikel,
    name-sg = artikel,
    Name-pl = Artikelen,
    name-pl = artikelen
}
\zcRefTypeSetup{para}{%
    Name-sg = Lid,
    name-sg = lid,
    Name-pl = Leden,
    name-pl = leden
}
\zcRefTypeSetup{parasi}{%
    Name-sg = Lid,
    name-sg = lid,
    Name-pl = Leden,
    name-pl = leden
}
\zcRefTypeSetup{parasii}{%
    Name-sg = Onderdeel,
    name-sg = onderdeel,
    Name-pl = Onderdelen,
    name-pl = onderdelen
}

\makeatother
{\catcode`\#=12 \gdef\hashchar{#}}
\makeatletter
\newcommand\@aref@hl[1]{\edef\next{%
    \noexpand\href{\@aref@fullurl}{#1}}\next}

% Artikel labels
\def\@aref@article@prefix{artikel~}
\def\@Aref@article@prefix{Artikel~}
\def\@aref@article@postfix{}
\def\@aref@article@format{\@aref@article}
\def\@aref@article@formathl{\@aref@hl{\@aref@article@format}}
\def\@aref@article@nformat{\@aref@article@prefix\@aref@article}
\def\@Aref@article@nformat{\@Aref@article@prefix\@aref@article}
\def\@aref@article@nformathl{\@aref@article@prefix\@aref@article@formathl}
\def\@Aref@article@nformathl{\@Aref@article@prefix\@aref@article@formathl}


% Lid labels
\def\@aref@para@prefix{}
\def\@Aref@para@prefix{}
\def\@aref@para@postfix{~lid}
\def\@aref@para@format{\ordinalstringnum{\@aref@para}}
\def\@Aref@para@format{\Ordinalstringnum{\@aref@para}}
\def\@aref@para@formathl{\@aref@hl{\@aref@para@format}}
\def\@Aref@para@formathl{\@aref@hl{\@Aref@para@format}}
\def\@aref@para@nformat{\@aref@para@format\@aref@para@postfix}
\def\@aref@para@nformathl{\@aref@para@formathl\@aref@para@postfix}
\def\@Aref@para@nformat{\@Aref@para@format\@aref@para@postfix}
\def\@Aref@para@nformathl{\@Aref@para@formathl\@aref@para@postfix}

% Sub labels
\def\@aref@sub@prefix{onderdeel~}
\def\@Aref@sub@prefix{Onderdeel~}
\def\@aref@sub@postfix{}
\def\@aref@sub@format{\abalphnum{\@aref@sub}}
\def\@aref@sub@formathl{\@aref@hl{\@aref@sub@format}}
\def\@aref@sub@nformat{\@aref@sub@prefix\@aref@sub@format}
\def\@aref@sub@nformathl{\@aref@sub@prefix\@aref@sub@formathl}
\def\@Aref@sub@nformat{\@Aref@sub@prefix\@aref@sub@format}
\def\@Aref@sub@nformathl{\@Aref@sub@prefix\@aref@sub@formathl}

\def\@ifartifactisset#1#2#3{%
    \pgfkeysifdefined{/artifact/#1/.is family}{#2}{#3}%
}

\newcommand\@aref@setvars[1]{%
    \def\@aref@count{\zref@extract{#1}{counter}}%
    \def\@aref@article{\zref@extract{#1}{article}}%
    \def\@aref@para{\zref@extract{#1}{para}}%
    \def\@aref@sub{\zref@extract{#1}{sub}}%
    \def\@aref@anchor{\zref@extract{#1}{anchor}}%
    \def\@aref@url{\zref@extractdefault{#1}{url}{}}%
    \def\@aref@fullurl{\@aref@url\hashchar\@aref@anchor}%
    \zref@ifrefcontainsprop{#1}{externaldocument}{%
        \def\@aref@filelabel{\zref@extract{#1}{externaldocument}}%
        \def\@aref@postlink{%
            \ifthenelse{\equal{\artifactfootnote{\@aref@filelabel}}{true}\and\equal{\artifactreferred{\@aref@filelabel}}{false}}{%
                \reffootnotelabel{\@aref@filelabel}%
            }{}%
        }%
    }{%
        \def\@aref@postlink{}%
    }%
    \ifthenelse{\equal{\@aref@count}{article}}{%
        \def\@aref@type{article}%
        \def\@aref@format{\@aref@article@formathl}%
        \def\@aref@formatn{\@ifacap{\@Aref@article@prefix}{\@aref@article@prefix}\@aref@format}%
        \def\@aref@prefix{\@ifacap{\@Aref@article@prefix}{\@aref@article@prefix}}%
        \def\@aref@postfix{}%
    }{%
        \ifthenelse{\equal{\@aref@count}{parasi}\OR\equal{\@aref@count}{para}}{%
            \def\@aref@type{para}%
            \def\@aref@format{\@ifacap{\@Aref@para@formathl}{\@aref@para@formathl}}%
            \def\@aref@formatn{\@aref@format\@aref@para@postfix}%
            \def\@aref@prefix{%
                \@ifacap{\@Aref@article@prefix}{\@aref@article@prefix}\@aref@article@format,~%
            }%
            \def\@aref@postfix{\@aref@para@postfix}%
        }{%
            \ifthenelse{\equal{\@aref@count}{parasii}}{%
                \def\@aref@type{sub}%
                \def\@aref@format{\@aref@sub@formathl}%
                \def\@aref@prefix{%
                    \@ifacap{\@Aref@article@prefix}{\@aref@article@prefix}\@aref@article@format,~%
                    \@ifacap{\@Aref@para@format}{\@aref@para@format}\@aref@para@postfix,~%
                    \@ifacap{\@Aref@sub@prefix}{\@aref@sub@prefix}%
                }%
                \def\@aref@postfix{}%
            }{%
                \def\@aref@type{page}%
                \def\@aref@format{??}%
                \def\@aref@prefix{}%
                \def\@aref@postfix{}%
            }%
        }%
    }%
    \def\@aref@number##1{\zref@extractdefault{##1}{\@aref@type}{-1}}%
}

\newboolean{aref@cap}
\def\@ifacap#1#2{\ifthenelse{\boolean{aref@cap}}{#1\setboolean{aref@cap}{false}}{#2}}

\newcommand{\aref}[1]{%
    \IfSubStr{#1}{,}{%
        \StrBefore[1]{#1}{,}[\firstarg]%
    }{%
        \def\firstarg{#1}%
    }%
    \@aref@setvars{\firstarg}%
    \@aref@prefix\aref@group{#1}\@aref@postfix\@aref@postlink%
}

\newcommand{\Aref}[1]{%
    \setboolean{aref@cap}{true}%
    \IfSubStr{#1}{,}{%
        \StrBefore[1]{#1}{,}[\Firstarg]%
    }{%
        \def\Firstarg{#1}%
    }%
    \@aref@setvars{\Firstarg}%
    \@aref@prefix\aref@group{#1}\@aref@postfix\@aref@postlink%
}

\def\listterminator{-1}

\newcommand\aref@group[1]{%
    \bubblesort{#1}%
    \expandafter\begincompaction\sortedlist,\listterminator,\relax%
}
\def\begincompaction#1,#2\relax{%
    \def\startlist{#1}%
    \def\currentendlist{#1}%
    \findendlist#2\relax%
}
\def\findendlist#1,#2\relax{%
    \@aref@setvars{#1}%
    \ifnum\numexpr\@aref@number{\currentendlist}+1\relax=\@aref@number{#1}\relax%
        \def\currentendlist{#1}%
        \findendlist#2\relax%
    \else%
        \@aref@setvars{\startlist}%
        \ifnum\@aref@number{\startlist}=\@aref@number{\currentendlist}\relax%
            \ignorespaces\@aref@format\unskip%
        \else%
            \ifnum\numexpr\@aref@number{\startlist}+1\relax=\@aref@number{\currentendlist}\relax%
                \ignorespaces\@aref@format\unskip%
                \ifnum\@aref@number{#1}=\listterminator\relax%
                    \lastconjunction%
                \else%
                    \middleconjunction%
                \fi\ignorespaces\@aref@setvars{\currentendlist}\@aref@format\unskip%
            \else%
                \ignorespaces\@aref@format\unskip\rangeconjunction\ignorespaces\@aref@setvars{\currentendlist}\@aref@format\unskip%
            \fi%
        \fi%
        \ifnum\@aref@number{#1}=\listterminator%
        \else%
            \IfStrEq{#2}{\listterminator,}{\lastconjunction}{\middleconjunction}\begincompaction#1,#2\relax%
        \fi%
    \fi%
}
\newcommand\bubblesort[1]{\def\sortedlist{}\sortlist#1,\listterminator,\relax}
\def\sortlist#1,#2,#3\relax{%
    \@aref@setvars{#1}%
    \ifnum\@aref@number{#2}=\listterminator\relax%
        \edef\sortedlist{\sortedlist#1}%
    \else%
        \ifnum\@aref@number{#1}<\@aref@number{#2}\relax%
            \edef\sortedlist{\sortedlist#1,}%
            \sortlist#2,#3\relax%
        \else%
            \let\tmp\sortedlist%
            \def\sortedlist{}%
            \expandafter\sortlist\tmp#2,#1,#3\relax%
        \fi%
    \fi%
}

\GetAllResetLists
\RegisterPostLabelHook{\zlabel}

\newglossary*{definitions}{Definitions}
\newglossary*{externals}{Externals}


\newcommand\newartifact[2]{%
    \pgfkeys{
        /artifact/#1/.is family,
        /artifact/#1,
        name/.initial = #1,
        filename/.initial = #1.pdf,
        footnote/.initial = true,
        url/.initial=,
        referred/.initial = false,
        defs/.initial=,
        author/.initial=<author>,
        subject/.initial=<subject>,
        description/.initial=<description>
    }
    \pgfkeys{/artifact/#1,#2}
}
\newcommand\@aget[2]{\pgfkeysvalueof{/artifact/#1/#2}}
\newcommand\artifactname[1]{\@aget{#1}{name}}
\newcommand\artifactfilename[1]{\@aget{#1}{filename}}
\newcommand\artifactfootnote[1]{\@aget{#1}{footnote}}
\newcommand\artifacturl[1]{\@aget{#1}{url}}
\newcommand\artifactreferred[1]{\@aget{#1}{referred}}
\newcommand\artifactdefs[1]{\@aget{#1}{defs}}
\newcommand\artifactauthor[1]{\@aget{#1}{author}}
\newcommand\artifactsubject[1]{\@aget{#1}{subject}}
\newcommand\artifactdescription[1]{\@aget{#1}{description}}

\newcommand\describe[1]{\setboolean{regulatory@defslisted}{true}\glstarget{#1}{\glsentrydesc{#1}}}
\newcommand\printdefs[1]{%
    \renewcommand{\glossarysection}[2][]{}%
    \renewcommand*{\glsnamefont}[1]{\textmd{#1}}%
    \setboolean{regulatory@defslisted}{true}%
    \glssetwidest{#1\quad}%
    \ifthenelse{\boolean{regulatory@usebib2gls}}{\printunsrtglossary[type=definitions,style=alttree,title={},nonumberlist=true]}{\printglossary[type=definitions,style=alttree,title={},nonumberlist=true]}}

\attachfilesetup{color=black}

\newcommand\reffootnotelabel[1]{%
\pgfkeys{/artifact/#1,referred=true}%
\def\@tmpfile{\artifactfilename{#1}}%
, van \artifactsubject{#1}\footnote{Bijlage: \textattachfile[description={\artifactdescription{#1}},subject={\artifactsubject{#1}},author={\artifactauthor{#1}}]{\@tmpfile}{\@tmpfile}}%
}

\newcommand\deffootnotelabel[1]{%
    \pgfkeys{/artifact/#1,referred=true}%
    \def\@tmpfile{\artifactfilename{#1}}%
    ~(zie \artifactsubject{#1}\footnote{Bijlage: \textattachfile[description={\artifactdescription{#1}},subject={\artifactsubject{#1}},author={\artifactauthor{#1}}]{\@tmpfile}{\@tmpfile}})%
}

\edef\@regulatory@bib@selection{}
\ifthenelse{\boolean{regulatory@alldefs}}{\edef\@regulatory@bib@selection{,selection=all}}{}

\newcommand\loadglsdefs[1]{%
    \setboolean{regulatory@defslisted}{true}%
    \ifthenelse{\boolean{regulatory@usebib2gls}}{%
        \GlsXtrLoadResources[type=definitions,src={#1},sort={nl-NL},category={defs}\@regulatory@bib@selection]%
    }{%
        \loadglsentries[definitions]{#1}%
    }%
}

\newcommand\loadextdefs[2][externals]{%
    \ifthenelse{\boolean{regulatory@usebib2gls}}{%
        \GlsXtrLoadResources[type=externals,src={#2},sort={nl-NL},category={#1}]%
    }{%
        \loadglsentries[externals]{#2}%
    }%
    \glsdefpostlink{#1}{%
        \ifthenelse{\equal{\artifactreferred{#1}}{true}}{}{%
            \deffootnotelabel{#1}%
        }%
    }%
}

\newcommand\refdocument[2][ext-]{%
    \newartifact{#2}{footnote=false}%
    \zexternaldocument[#1]{#2}%
}

\newcommand\masterdocument[3][ext-]{%
    \newartifact{#2}{#3}%
    \zexternaldocument[#1]{#2}%
    \ifthenelse{\equal{\string\artifactdefs{#2}}{}}{%
        \PackageWarning{regulatory}{No definitions given to the master document. \the\gls commands will therefore not work.}%
    }{%
        \loadextdefs[#2]{\artifactdefs{#2}}%
        \ifthenelse{\boolean{regulatory@usebib2gls}}{%
            \glssetcategoryattribute{#2}{targeturl}{\artifactfilename{#2}}%
            \glssetcategoryattribute{#2}{targetname}{\glolinkprefix\glslabel}%
        }{}%
    }%
}

\AtEndPreamble{\ifthenelse{\boolean{regulatory@usebib2gls}}{}{\ifthenelse{\boolean{regulatory@defslisted}}{\makeglossaries}{}}}
\AtEndDocument{\ifthenelse{\boolean{regulatory@alldefs}}{\glsaddallunused}{}}
